{% comment %}
  ============================================
  CYRASOUL - Visual Bundle Builder v2
  Features: Ke≈üfet Cards, Synergy Map, Achievements
  Mobile-first design
  ============================================
{% endcomment %}

<section
  id="wellness-architect"
  class="wellness-architect"
  data-section-id="{{ section.id }}"
>
  <!-- Header -->
  <div class="wa-header">
    <span class="wa-header__eyebrow">{{ section.settings.eyebrow_text }}</span>
    <h2 class="wa-header__title">{{ section.settings.title }}</h2>
    <p class="wa-header__subtitle">{{ section.settings.subtitle }}</p>
  </div>

  <div class="wa-container">
    <!-- Product Grid -->
    <div class="wa-products" role="region" aria-label="Mevcut √ºr√ºnler">
      {% assign collection = collections[section.settings.collection] %}
      {% for product in collection.products limit: section.settings.product_limit %}
        <article
          class="wa-product-card"
          data-product-id="{{ product.id }}"
          data-product-handle="{{ product.handle }}"
          data-product-title="{{ product.title }}"
          data-product-price="{{ product.price }}"
          data-product-image="{{ product.featured_image | image_url: width: 400 }}"
          data-variant-id="{{ product.first_available_variant.id }}"
          data-product-url="{{ product.url }}"
          tabindex="0"
          role="button"
          aria-label="{{ product.title }} √ºr√ºn√ºn√º rit√ºeline ekle"
        >
          <div class="wa-product-card__image-wrapper">
            <img
              src="{{ product.featured_image | image_url: width: 400 }}"
              alt="{{ product.title }}"
              class="wa-product-card__image"
              loading="lazy"
            >
          </div>

          <div class="wa-product-card__content">
            <h3 class="wa-product-card__title">{{ product.title }}</h3>
            <p class="wa-product-card__price">{{ product.price | money }}</p>
          </div>

          <!-- Ke≈üfet Button -->
          <button class="wa-product-card__kesfet-btn" data-kesfet-toggle aria-label="√úr√ºn detaylarƒ±nƒ± ke≈üfet">
            <span>Ke≈üfet</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Ke≈üfet Drawer -->
          <div class="wa-product-card__drawer" aria-hidden="true">
            <div class="wa-product-card__drawer-tabs">
              <button class="wa-tab wa-tab--active" data-tab="benefits">Faydalar</button>
              <button class="wa-tab" data-tab="ingredients">ƒ∞√ßindekiler</button>
              <button class="wa-tab" data-tab="science">Bilim</button>
            </div>
            <div class="wa-product-card__drawer-content"></div>
          </div>

          <button class="wa-product-card__add-btn" aria-label="{{ product.title }} ekle">
            <svg class="wa-product-card__icon-add" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <svg class="wa-product-card__icon-check" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </button>
        </article>
      {% endfor %}
    </div>

    <!-- Desktop Sidebar -->
    <aside class="wa-sidebar">
      <div class="wa-sidebar__header">
        <h3 class="wa-sidebar__title">Rit√ºel Kutunuz</h3>
        <span class="wa-sidebar__count">0 √ºr√ºn</span>
      </div>

      <!-- Discount Steps (moved up like mobile) -->
      <div class="wa-sidebar__synergy">
        <div class="wa-sidebar__synergy-header">
          <span>ƒ∞ndirim Seviyesi</span>
          <span class="wa-sidebar__synergy-text">Ba≈ülayƒ±n</span>
        </div>
        <div class="wa-steps">
          <div class="wa-step" data-step="1"><span class="wa-step__dot"></span><span class="wa-step__label"></span></div>
          <div class="wa-step" data-step="2"><span class="wa-step__dot"></span><span class="wa-step__label">%15</span></div>
          <div class="wa-step" data-step="3"><span class="wa-step__dot"></span><span class="wa-step__label">%20</span></div>
          <div class="wa-step" data-step="4"><span class="wa-step__dot"></span><span class="wa-step__label">%25</span></div>
          <div class="wa-step" data-step="5"><span class="wa-step__dot"></span><span class="wa-step__label">%30</span></div>
        </div>
      </div>

      <!-- Selected Items -->
      <div class="wa-sidebar__items-container">
        <div class="wa-sidebar__empty-state">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          </svg>
          <p>Rit√ºelinizi olu≈üturmak i√ßin<br>√ºr√ºn se√ßin</p>
        </div>
        <div class="wa-sidebar__items"></div>
      </div>

      <!-- Pricing + Checkout (moved up for visibility) -->
      <div class="wa-sidebar__pricing">
        <div class="wa-sidebar__price-row">
          <span>Ara Toplam</span>
          <span class="wa-sidebar__subtotal">‚Ç∫0</span>
        </div>
        <div class="wa-sidebar__price-row wa-sidebar__price-row--discount" style="display: none;">
          <span>Paket ƒ∞ndirimi</span>
          <span class="wa-sidebar__discount">-‚Ç∫0</span>
        </div>
        <div class="wa-sidebar__price-row wa-sidebar__price-row--total">
          <span>Toplam</span>
          <span class="wa-sidebar__total">‚Ç∫0</span>
        </div>
      </div>

      <button class="wa-sidebar__checkout-btn" disabled>
        <span class="wa-sidebar__checkout-text">Sepeti Onayla</span>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>

      <!-- Combined Synergy Map + Achievements (v2 merged) -->
      <div class="wa-synergy-achievements" style="display: none;">
        <div class="wa-synergy-achievements__header">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
          </svg>
          <span>Birlikte Kullanƒ±m</span>
        </div>
        <!-- Hexagon Synergy Map -->
        <div class="wa-synergy-map__scroll">
          <svg class="wa-synergy-map__svg" viewBox="0 0 400 280"></svg>
          <div class="wa-synergy-map__labels"></div>
        </div>
        <!-- Achievement Icons Row -->
        <div class="wa-achievement-icons">
          <div class="wa-achievement-icon" data-achievement="first-step" title="ƒ∞lk Adƒ±m">
            <span class="wa-achievement-icon__emoji">üå±</span>
          </div>
          <div class="wa-achievement-icon" data-achievement="power-duo" title="G√º√ßl√º ƒ∞kili">
            <span class="wa-achievement-icon__emoji">‚ö°</span>
          </div>
          <div class="wa-achievement-icon" data-achievement="triple-threat" title="√ú√ßl√º Kuvvet">
            <span class="wa-achievement-icon__emoji">üî•</span>
          </div>
          <div class="wa-achievement-icon" data-achievement="ritual-master" title="Rit√ºel Ustasƒ±">
            <span class="wa-achievement-icon__emoji">‚ú®</span>
          </div>
          <div class="wa-achievement-icon" data-achievement="wellness-architect" title="Wellness Architect">
            <span class="wa-achievement-icon__emoji">üèÜ</span>
          </div>
        </div>
        <!-- Synergy Explanations List (icons + descriptions) -->
        <div class="wa-synergy-list"></div>
        <!-- Unlock Explanation Box -->
        <div class="wa-achievement-unlock-box" style="display: none;"></div>
      </div>

      <!-- Recommendation Box -->
      <div class="wa-recommendation" style="display: none;">
        <div class="wa-recommendation__header">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path>
          </svg>
          <span>Akƒ±llƒ± √ñneri</span>
        </div>
        <div class="wa-recommendation__content">
          <div class="wa-recommendation__product">
            <img src="" alt="" class="wa-recommendation__image">
            <div class="wa-recommendation__info">
              <span class="wa-recommendation__label">√ñnerilen √úr√ºn</span>
              <span class="wa-recommendation__name"></span>
            </div>
          </div>
          <div class="wa-recommendation__bundle-name"></div>
          <p class="wa-recommendation__reason"></p>
          <button class="wa-recommendation__add-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            √ñnerilen √úr√ºnu Ekle
          </button>
        </div>
      </div>

      <!-- Synergy Explanation -->
      <div class="wa-synergy-explanation" style="display: none;"></div>

      <!-- Ritual Guide -->
      <div class="wa-ritual-guide" style="display: none;">
        <div class="wa-ritual-guide__header">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span>Kullanƒ±m Rehberi</span>
        </div>
        <div class="wa-ritual-guide__content"></div>
      </div>
    </aside>
  </div>

  <!-- Mobile Dock -->
  <div class="wa-dock wa-dock--empty">
    <div class="wa-dock__handle"><span></span></div>

    <div class="wa-dock__collapsed">
      <div class="wa-dock__collapsed-left">
        <div class="wa-dock__preview">
          <span class="wa-dock__empty-text">√úr√ºn Se√ßin</span>
          <div class="wa-dock__thumbnails"></div>
        </div>
        <div class="wa-dock__collapsed-info">
          <span class="wa-dock__item-count">0 √ºr√ºn</span>
          <span class="wa-dock__synergy-badge">Ba≈ülayƒ±n</span>
        </div>
      </div>
      <div class="wa-dock__collapsed-right">
        <div class="wa-dock__mini-total">‚Ç∫0</div>
        <button class="wa-dock__expand-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="18 15 12 9 6 15"></polyline>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Synergy Summary -->
    <div class="wa-dock__synergy-summary" style="display: none;">
      <div class="wa-steps wa-steps--mini">
        <span class="wa-step" data-step="1" title="%15"></span>
        <span class="wa-step" data-step="2" title="%20"></span>
        <span class="wa-step" data-step="3" title="%25"></span>
        <span class="wa-step" data-step="4" title="%30"></span>
        <span class="wa-step" data-step="5" title="MAX"></span>
      </div>
      <p class="wa-dock__synergy-summary-text"></p>
    </div>

    <!-- Mobile Expanded View -->
    <div class="wa-dock__expanded">
      <div class="wa-dock__expanded-header">
        <h3>Rit√ºeliniz</h3>
        <button class="wa-dock__close-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="wa-dock__items"></div>

      <!-- Discount Steps (moved to top) -->
      <div class="wa-dock__discount-steps" style="display: none;">
        <div class="wa-dock__discount-steps-header">
          <span class="wa-dock__discount-steps-title">ƒ∞ndirim Seviyesi</span>
          <span class="wa-dock__discount-steps-current">Ba≈ülayƒ±n</span>
        </div>
        <div class="wa-steps wa-steps--top">
          <div class="wa-step" data-step="1"><span class="wa-step__dot"></span><span class="wa-step__label"></span></div>
          <div class="wa-step" data-step="2"><span class="wa-step__dot"></span><span class="wa-step__label">%15</span></div>
          <div class="wa-step" data-step="3"><span class="wa-step__dot"></span><span class="wa-step__label">%20</span></div>
          <div class="wa-step" data-step="4"><span class="wa-step__dot"></span><span class="wa-step__label">%25</span></div>
          <div class="wa-step" data-step="5"><span class="wa-step__dot"></span><span class="wa-step__label">%30</span></div>
        </div>
        <p class="wa-dock__discount-hint-text"></p>
      </div>

      <!-- Combined Synergy Map + Synergy List -->
      <div class="wa-dock__synergy-achievements" style="display: none;">
        <div class="wa-synergy-achievements__header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
          </svg>
          <span>Birlikte Kullanƒ±m</span>
        </div>
        <!-- Hexagon Synergy Map -->
        <div class="wa-synergy-map__scroll">
          <svg class="wa-synergy-map__svg" viewBox="0 0 400 280"></svg>
          <div class="wa-synergy-map__labels"></div>
        </div>
        <!-- Synergy Explanations List (icons + descriptions) -->
        <div class="wa-synergy-list"></div>
      </div>

      <!-- Mobile Recommendation -->
      <div class="wa-dock__recommendation" style="display: none;">
        <div class="wa-dock__recommendation-header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path>
          </svg>
          <span>√ñnerilen</span>
        </div>
        <div class="wa-dock__recommendation-content">
          <img src="" alt="" class="wa-dock__recommendation-img">
          <div class="wa-dock__recommendation-info">
            <span class="wa-dock__recommendation-name"></span>
            <span class="wa-dock__recommendation-bundle"></span>
          </div>
          <button class="wa-dock__recommendation-add">Ekle</button>
        </div>
      </div>

      <!-- Mobile Synergy Explanation -->
      <div class="wa-dock__synergy-explanation" style="display: none;"></div>

      <!-- Mobile Ritual Guide -->
      <div class="wa-dock__ritual" style="display: none;"></div>

      <!-- Mobile Pricing Summary -->
      <div class="wa-dock__pricing">
        <div class="wa-dock__price-row">
          <span>Ara Toplam</span>
          <span class="wa-dock__subtotal">‚Ç∫0</span>
        </div>
        <div class="wa-dock__price-row wa-dock__price-row--discount" style="display: none;">
          <span>ƒ∞ndirim</span>
          <span class="wa-dock__discount">-‚Ç∫0</span>
        </div>
        <div class="wa-dock__price-row wa-dock__price-row--total">
          <span>Net Tutar</span>
          <span class="wa-dock__net-total">‚Ç∫0</span>
        </div>
      </div>
    </div>

    <!-- Sticky Checkout Footer (only visible when expanded via CSS) -->
    <div class="wa-dock__checkout-footer">
      <div class="wa-dock__checkout-total">
        <span class="wa-dock__checkout-total-label">Toplam</span>
        <span class="wa-dock__checkout-total-value wa-dock__total">‚Ç∫0</span>
      </div>
      <button class="wa-dock__checkout-btn" disabled>
        Sepeti Onayla
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="wa-particles"></div>

  <!-- Ke≈üfet Full Screen Modal -->
  <div class="wa-kesfet-modal" id="kesfet-modal">
    <div class="wa-kesfet-modal__header">
      <button class="wa-kesfet-modal__back" aria-label="Geri">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </button>
      <h3 class="wa-kesfet-modal__title"></h3>
      <button class="wa-kesfet-modal__close" aria-label="Kapat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="wa-kesfet-modal__product">
      <img class="wa-kesfet-modal__image" src="" alt="">
      <div class="wa-kesfet-modal__timing"></div>
    </div>
    <div class="wa-kesfet-modal__tabs">
      <button class="wa-tab wa-tab--active" data-tab="benefits">Faydalar</button>
      <button class="wa-tab" data-tab="ingredients">ƒ∞√ßindekiler</button>
      <button class="wa-tab" data-tab="science">Bilim</button>
      <button class="wa-tab" data-tab="combinations">Kombinasyonlar</button>
    </div>
    <div class="wa-kesfet-modal__content"></div>
    <div class="wa-kesfet-modal__footer">
      <button class="wa-kesfet-modal__add-btn">
        <span class="wa-kesfet-modal__add-text">Sepete Ekle</span>
      </button>
      <div class="wa-kesfet-modal__qty-controls" style="display:none;">
        <button class="wa-kesfet-modal__qty-btn wa-kesfet-modal__qty-minus" data-action="minus">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <span class="wa-kesfet-modal__qty-value">1</span>
        <button class="wa-kesfet-modal__qty-btn wa-kesfet-modal__qty-plus" data-action="plus">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>
  </div>
</section>

<style>
  :root {
    --wa-black: #000000;
    --wa-dark: #111111;
    --wa-gray-900: #1a1a1a;
    --wa-gray-800: #2d2d2d;
    --wa-gray-700: #404040;
    --wa-gray-600: #525252;
    --wa-gray-500: #737373;
    --wa-gray-400: #a3a3a3;
    --wa-gray-300: #d4d4d4;
    --wa-gray-200: #e5e5e5;
    --wa-gray-100: #f5f5f5;
    --wa-white: #ffffff;
    --wa-success: #22c55e;
    --wa-gold: #FFD700;
    --wa-radius: 12px;
    --wa-radius-sm: 8px;
    --wa-shadow: 0 1px 3px rgba(0,0,0,0.1);
    --wa-shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
    --wa-transition: 0.2s ease;
    --wa-dock-height: 95px;
  }

  .wellness-architect {
    position: relative;
    padding: 2rem 1rem;
    padding-bottom: calc(var(--wa-dock-height) + 2rem);
    background: var(--wa-white);
    min-height: 100vh;
    font-family: inherit;
    color: var(--wa-black);
  }

  .wellness-architect * { box-sizing: border-box; }

  /* Header */
  .wa-header {
    text-align: center;
    margin-bottom: 2.5rem;
    max-width: 500px;
    margin-inline: auto;
  }

  .wa-header__eyebrow {
    display: inline-block;
    background: var(--wa-black);
    color: var(--wa-white);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    padding: 0.4rem 1rem;
    border-radius: 100px;
    margin-bottom: 1rem;
  }

  .wa-header__title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--wa-black);
    margin: 0 0 0.75rem 0;
    letter-spacing: -0.02em;
  }

  .wa-header__subtitle {
    font-size: 0.9rem;
    color: var(--wa-gray-500);
    margin: 0;
    line-height: 1.5;
  }

  /* Container */
  .wa-container { max-width: 1200px; margin: 0 auto; }

  /* Product Grid - Mobile: single column with safe margins, Desktop: 3 columns */
  .wa-products {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 320px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* Product Card - Mobile optimized (30-35% smaller) */
  .wa-product-card {
    position: relative;
    background: var(--wa-white);
    border: 2px solid var(--wa-gray-200);
    border-radius: var(--wa-radius);
    overflow: hidden;
    cursor: pointer;
    transition: all var(--wa-transition);
    display: flex;
    flex-direction: row;
    align-items: stretch;
  }

  .wa-product-card:hover { border-color: var(--wa-gray-300); }
  .wa-product-card:active { transform: scale(0.98); }

  .wa-product-card--added {
    border-color: var(--wa-black);
    background: var(--wa-gray-100);
  }

  .wa-product-card--added .wa-product-card__add-btn { background: var(--wa-success); }
  .wa-product-card--added .wa-product-card__icon-add { display: none; }
  .wa-product-card--added .wa-product-card__icon-check { display: block; }
  .wa-product-card__icon-check { display: none; }

  .wa-product-card--recommended {
    border-color: var(--wa-black);
    box-shadow: 0 0 0 1px var(--wa-black);
  }

  .wa-product-card--recommended::before {
    content: '√ñnerilen';
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--wa-black);
    color: var(--wa-white);
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    z-index: 5;
  }

  .wa-product-card--loading { pointer-events: none; opacity: 0.7; }

  .wa-product-card__image-wrapper {
    width: 80px;
    min-width: 80px;
    height: 80px;
    background: var(--wa-gray-100);
    overflow: hidden;
    flex-shrink: 0;
  }

  .wa-product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--wa-transition);
  }

  .wa-product-card:hover .wa-product-card__image { transform: scale(1.03); }

  .wa-product-card__content {
    padding: 0.6rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-grow: 1;
    min-width: 0;
  }

  .wa-product-card__title {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--wa-black);
    margin: 0 0 0.15rem 0;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .wa-product-card__price {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--wa-gray-500);
    margin: 0;
  }

  .wa-product-card__add-btn {
    position: absolute;
    top: 50%;
    right: 0.5rem;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--wa-black);
    color: var(--wa-white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--wa-transition);
    z-index: 2;
  }

  .wa-product-card__add-btn:hover { transform: translateY(-50%) scale(1.1); }

  /* Ke≈üfet Button & Drawer */
  .wa-product-card__kesfet-btn {
    position: absolute;
    bottom: 55px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    background: var(--wa-white);
    border: 1px solid var(--wa-gray-300);
    border-radius: 16px;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--wa-gray-600);
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    z-index: 3;
  }

  .wa-product-card:hover .wa-product-card__kesfet-btn,
  .wa-product-card--drawer-open .wa-product-card__kesfet-btn { opacity: 1; }

  .wa-product-card__kesfet-btn svg { transition: transform 0.3s ease; }
  .wa-product-card--drawer-open .wa-product-card__kesfet-btn svg { transform: rotate(180deg); }

  .wa-product-card__drawer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--wa-white);
    border-top: 1px solid var(--wa-gray-200);
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    z-index: 10;
  }

  .wa-product-card--drawer-open .wa-product-card__drawer { max-height: 250px; }

  .wa-product-card__drawer-tabs {
    display: flex;
    border-bottom: 1px solid var(--wa-gray-200);
    padding: 0 6px;
  }

  .wa-tab {
    flex: 1;
    padding: 8px 4px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--wa-gray-500);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .wa-tab--active {
    color: var(--wa-black);
    border-bottom-color: var(--wa-black);
  }

  .wa-product-card__drawer-content {
    padding: 10px;
    max-height: 180px;
    overflow-y: auto;
    font-size: 0.7rem;
  }

  /* Benefit Items */
  .wa-benefit-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid var(--wa-gray-100);
  }

  .wa-benefit-item:last-child { border-bottom: none; }

  .wa-benefit-icon {
    width: 22px;
    height: 22px;
    background: var(--wa-gray-100);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .wa-benefit-title {
    font-size: 0.7rem;
    font-weight: 600;
    margin: 0 0 2px 0;
  }

  .wa-benefit-desc {
    font-size: 0.65rem;
    color: var(--wa-gray-500);
    margin: 0;
  }

  /* Ingredient Items */
  .wa-ingredient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--wa-gray-100);
  }

  .wa-ingredient-name { font-weight: 600; }
  .wa-ingredient-amount { color: var(--wa-gray-500); font-size: 0.65rem; }
  .wa-ingredient-benefit { font-size: 0.6rem; color: var(--wa-gray-400); }

  /* Science Content */
  .wa-science-content { line-height: 1.5; color: var(--wa-gray-600); }
  .wa-science-title { font-weight: 600; color: var(--wa-black); margin-bottom: 6px; }

  /* Desktop Sidebar - Hidden on mobile */
  .wa-sidebar { display: none; }

  /* Mobile Dock */
  .wa-dock {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--wa-white);
    border-top: 1px solid var(--wa-gray-200);
    z-index: 999;
    transition: height 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
    height: var(--wa-dock-height);
    overflow: hidden;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  }

  .wa-dock--empty {
    transform: translateY(100%);
    opacity: 0;
    pointer-events: none;
  }

  .wa-dock--expanded {
    height: 95vh;
    border-radius: var(--wa-radius) var(--wa-radius) 0 0;
    border-top: none;
    box-shadow: var(--wa-shadow-lg);
    overflow-y: auto;
  }

  .wa-dock__handle {
    display: flex;
    justify-content: center;
    padding: 0.5rem;
    cursor: pointer;
  }

  .wa-dock__handle span {
    width: 36px;
    height: 4px;
    background: var(--wa-gray-300);
    border-radius: 2px;
  }

  .wa-dock__collapsed {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    min-height: 50px;
  }

  .wa-dock--expanded .wa-dock__collapsed { display: none; }

  .wa-dock__collapsed-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .wa-dock__preview {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .wa-dock__empty-text {
    font-size: 0.85rem;
    color: var(--wa-gray-500);
  }

  .wa-dock__thumbnails { display: flex; }

  .wa-dock__thumbnail {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--wa-white);
    object-fit: cover;
    margin-left: -6px;
    box-shadow: var(--wa-shadow);
  }

  .wa-dock__thumbnail:first-child { margin-left: 0; }

  .wa-dock__collapsed-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .wa-dock__item-count {
    font-size: 0.7rem;
    color: var(--wa-gray-500);
  }

  .wa-dock__synergy-badge {
    font-size: 0.65rem;
    font-weight: 600;
    background: var(--wa-gray-100);
    color: var(--wa-gray-600);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }

  .wa-dock__synergy-badge--active {
    background: var(--wa-black);
    color: var(--wa-white);
  }

  .wa-dock__collapsed-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .wa-dock__mini-total {
    font-size: 1rem;
    font-weight: 700;
    color: var(--wa-black);
  }

  .wa-dock__expand-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--wa-black);
    color: var(--wa-white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Mobile Synergy Summary */
  .wa-dock__synergy-summary {
    padding: 0.25rem 1rem 0.5rem;
    border-top: 1px solid var(--wa-gray-100);
  }

  .wa-dock--expanded .wa-dock__synergy-summary { display: none !important; }

  .wa-dock__synergy-summary-text {
    font-size: 0.65rem;
    color: var(--wa-gray-600);
    margin: 0;
    line-height: 1.2;
  }

  /* Dock Expanded */
  .wa-dock__expanded {
    display: none;
    padding: 0 1rem 1.5rem;
  }

  .wa-dock--expanded .wa-dock__expanded { display: block; }

  .wa-dock__expanded-header {
    position: sticky;
    top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin: 0 -16px 1rem -16px;
    background: var(--wa-white);
    border-bottom: 1px solid var(--wa-gray-200);
    z-index: 10;
  }

  .wa-dock__expanded-header h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
  }

  .wa-dock__close-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--wa-gray-100);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--wa-gray-600);
  }

  .wa-dock__items {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .wa-dock__item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
  }

  .wa-dock__item-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
  }

  .wa-dock__item-image {
    width: 36px;
    height: 36px;
    border-radius: var(--wa-radius-sm);
    object-fit: cover;
  }

  .wa-dock__item-info { flex: 1; min-width: 0; }

  .wa-dock__item-title {
    font-size: 0.75rem;
    font-weight: 600;
    margin: 0 0 0.1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .wa-dock__item-benefit {
    font-size: 0.6rem;
    color: var(--wa-gray-600);
    margin: 0;
    font-weight: 500;
  }

  .wa-dock__item-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .wa-dock__item-qty {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--wa-white);
    border-radius: 6px;
    padding: 0.25rem;
  }

  .wa-dock__item-qty-btn {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--wa-gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 600;
  }

  .wa-dock__item-qty-btn:hover { background: var(--wa-gray-100); }

  .wa-dock__item-qty-value {
    min-width: 20px;
    text-align: center;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .wa-dock__item-remove {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--wa-gray-400);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wa-dock__item-remove:hover {
    background: #fee2e2;
    color: #ef4444;
  }

  /* Synergy Map */
  .wa-synergy-map {
    margin: 1rem 0;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
    overflow: hidden;
  }

  .wa-synergy-map__header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 12px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--wa-black);
    border-bottom: 1px solid var(--wa-gray-200);
  }

  .wa-synergy-map__scroll {
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    position: relative;
    padding: 12px;
  }

  .wa-synergy-map__svg {
    min-width: 100%;
    width: 100%;
    height: 260px;
    display: block;
  }

  .wa-synergy-node__bg {
    fill: var(--wa-white);
    stroke: var(--wa-gray-200);
    stroke-width: 2;
  }

  .wa-synergy-node__ring {
    fill: none;
    stroke: var(--wa-black);
    stroke-width: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .wa-synergy-node--active .wa-synergy-node__ring { opacity: 1; }

  .wa-synergy-map__labels {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }

  .wa-synergy-label {
    position: absolute;
    transform: translate(-50%, -50%);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 0.6rem;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }

  .wa-synergy-label--icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    z-index: 10;
  }

  /* Achievement Icons Row */
  .wa-achievement-icons {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 12px 8px;
    margin-top: 8px;
    border-top: 1px solid var(--wa-gray-200);
  }

  .wa-achievement-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--wa-gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.4;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .wa-achievement-icon--unlocked {
    background: var(--wa-gold);
    opacity: 1;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
  }

  .wa-achievement-icon--unlocking {
    animation: achievement-unlock 0.5s ease;
  }

  @keyframes achievement-unlock {
    0% { transform: scale(0.8) rotate(-10deg); }
    50% { transform: scale(1.2) rotate(10deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  .wa-achievement-icon__emoji {
    font-size: 1.1rem;
    line-height: 1;
  }

  .wa-synergy-node--selected .wa-synergy-node__bg {
    stroke: var(--wa-black);
    stroke-width: 3;
  }

  .wa-synergy-node--inactive {
    opacity: 0.4;
  }

  .wa-synergy-node:hover {
    opacity: 1;
  }

  .wa-synergy-node:hover .wa-synergy-node__bg {
    stroke: var(--wa-black);
    stroke-width: 2;
  }

  .wa-synergy-node__glow {
    fill: none;
    stroke: var(--wa-black);
    stroke-width: 2;
    opacity: 0.3;
    animation: node-glow 2s ease-in-out infinite;
  }

  @keyframes node-glow {
    0%, 100% { opacity: 0.2; r: attr(r); }
    50% { opacity: 0.5; }
  }

  .wa-synergy-node__label {
    font-size: 9px;
    font-weight: 600;
    fill: var(--wa-gray-600);
  }

  .wa-synergy-node--selected .wa-synergy-node__label {
    fill: var(--wa-black);
  }

  .wa-synergy-line {
    stroke-width: 2;
    opacity: 0.6;
    stroke-dasharray: 6 4;
    animation: line-dash 1s linear infinite;
  }

  @keyframes line-dash {
    to { stroke-dashoffset: -10; }
  }

  .wa-synergy-line--strong { stroke-width: 3; opacity: 0.8; }
  .wa-synergy-line--medium { stroke-width: 2; opacity: 0.7; }

  /* Combined Synergy + Achievements (v2 merged) */
  .wa-synergy-achievements,
  .wa-dock__synergy-achievements {
    margin: 1rem 0;
    padding: 12px;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius);
  }

  .wa-synergy-achievements__header {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--wa-black);
    margin-bottom: 12px;
  }

  .wa-synergy-achievements__header svg {
    color: var(--wa-gray-500);
  }

  /* Synergy List (explanations below map) */
  .wa-synergy-list {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--wa-gray-200);
  }

  .wa-synergy-list-item {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--wa-gray-100);
  }

  .wa-synergy-list-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .wa-synergy-list-item:first-child {
    padding-top: 0;
  }

  .wa-synergy-list-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1rem;
  }

  .wa-synergy-list-content {
    flex: 1;
    min-width: 0;
  }

  .wa-synergy-list-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--wa-black);
    margin-bottom: 2px;
  }

  .wa-synergy-list-benefit {
    font-size: 0.7rem;
    color: var(--wa-gray-600);
    line-height: 1.4;
  }

  /* Synergy connection icon on map */
  .wa-synergy-connection-icon {
    font-size: 0.7rem;
    pointer-events: none;
  }

  .wa-synergy-connection-icon-bg {
    fill: white;
  }

  @keyframes slide-up {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .wa-achievement-unlock-box__header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 6px;
    color: var(--wa-black);
  }

  .wa-achievement-unlock-box__emoji {
    font-size: 1.2rem;
  }

  .wa-achievement-unlock-box__text {
    font-size: 0.75rem;
    color: var(--wa-gray-600);
    line-height: 1.4;
    margin: 0;
  }

  /* Achievement System */
  .wa-achievement-progress {
    margin: 1rem 0;
    padding: 12px;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
  }

  .wa-achievement-progress__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .wa-achievement-progress__title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--wa-black);
  }

  .wa-achievement-progress__count {
    font-size: 0.7rem;
    color: var(--wa-gray-500);
  }

  .wa-achievement-progress__bar {
    height: 6px;
    background: var(--wa-gray-200);
    border-radius: 3px;
    overflow: hidden;
  }

  .wa-achievement-progress__fill {
    height: 100%;
    background: linear-gradient(90deg, var(--wa-gold), #FFA500);
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .wa-achievement-progress__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  .wa-achievement-badge {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--wa-gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.4;
    transition: all 0.3s ease;
  }

  .wa-achievement-badge--unlocked {
    background: var(--wa-gold);
    opacity: 1;
    box-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
  }

  .wa-achievement-badge svg { width: 14px; height: 14px; }

  /* Achievement Notification */
  .wa-achievement-notification {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--wa-black);
    color: var(--wa-white);
    padding: 10px 16px;
    border-radius: var(--wa-radius);
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10000;
  }

  .wa-achievement-notification--visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .wa-achievement-notification--hiding {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }

  .wa-achievement-notification__icon {
    width: 36px;
    height: 36px;
    background: var(--wa-gray-800);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .wa-achievement-notification__icon--locked { background: var(--wa-gray-600); }

  .wa-achievement-notification__icon--unlocking {
    background: var(--wa-gold);
    animation: unlock-bounce 0.5s ease;
  }

  @keyframes unlock-bounce {
    0% { transform: rotate(-30deg) scale(0.8); }
    50% { transform: rotate(15deg) scale(1.2); }
    100% { transform: rotate(0deg) scale(1); }
  }

  .wa-achievement-notification__icon svg { stroke: var(--wa-white); }
  .wa-achievement-notification__icon--unlocking svg { stroke: var(--wa-black); }

  .wa-achievement-notification__label {
    display: block;
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--wa-gold);
    margin-bottom: 2px;
  }

  .wa-achievement-notification__title {
    display: block;
    font-size: 0.85rem;
    font-weight: 700;
  }

  /* Ke≈üfet Full Screen Modal */
  .wa-kesfet-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--wa-white);
    z-index: 10000;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .wa-kesfet-modal--open {
    transform: translateY(0);
  }

  .wa-kesfet-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--wa-gray-200);
    background: var(--wa-white);
    flex-shrink: 0;
  }

  .wa-kesfet-modal__back,
  .wa-kesfet-modal__close {
    width: 40px;
    height: 40px;
    border: none;
    background: var(--wa-gray-100);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .wa-kesfet-modal__back:hover,
  .wa-kesfet-modal__close:hover {
    background: var(--wa-gray-200);
  }

  .wa-kesfet-modal__title {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    flex: 1;
    text-align: center;
  }

  .wa-kesfet-modal__product {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 16px;
    background: var(--wa-gray-100);
    flex-shrink: 0;
  }

  .wa-kesfet-modal__image {
    width: 120px;
    height: 120px;
    object-fit: contain;
    border-radius: 12px;
    background: var(--wa-white);
    padding: 8px;
  }

  .wa-kesfet-modal__timing {
    margin-top: 12px;
    font-size: 0.8rem;
    color: var(--wa-gray-600);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .wa-kesfet-modal__tabs {
    display: flex;
    border-bottom: 1px solid var(--wa-gray-200);
    padding: 0 16px;
    flex-shrink: 0;
    background: var(--wa-white);
  }

  .wa-kesfet-modal__tabs .wa-tab {
    flex: 1;
    padding: 14px 8px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--wa-gray-500);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .wa-kesfet-modal__tabs .wa-tab--active {
    color: var(--wa-black);
    border-bottom-color: var(--wa-black);
  }

  .wa-kesfet-modal__content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 16px;
    -webkit-overflow-scrolling: touch;
  }

  .wa-kesfet-modal__footer {
    padding: 16px;
    border-top: 1px solid var(--wa-gray-200);
    background: var(--wa-white);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }

  .wa-kesfet-modal__add-btn {
    width: auto;
    min-width: 140px;
    padding: 10px 20px;
    background: var(--wa-black);
    color: var(--wa-white);
    border: none;
    border-radius: var(--wa-radius-sm);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 auto;
    display: block;
  }

  .wa-kesfet-modal__add-btn:hover {
    background: var(--wa-gray-800);
    transform: translateY(-1px);
  }

  .wa-kesfet-modal__add-btn--added {
    background: var(--wa-success);
  }

  .wa-kesfet-modal__qty-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: auto;
    padding: 6px 12px;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
    margin: 0 auto;
  }

  .wa-kesfet-modal__qty-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid var(--wa-gray-300);
    background: var(--wa-white);
    color: var(--wa-gray-700);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .wa-kesfet-modal__qty-btn:hover {
    border-color: var(--wa-black);
    color: var(--wa-black);
  }

  .wa-kesfet-modal__qty-btn svg {
    pointer-events: none;
  }

  .wa-kesfet-modal__qty-minus:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
  }

  .wa-kesfet-modal__qty-plus:hover {
    border-color: var(--wa-success);
    color: var(--wa-success);
    background: #f0fdf4;
  }

  .wa-kesfet-modal__qty-value {
    font-size: 1rem;
    font-weight: 700;
    min-width: 32px;
    text-align: center;
    color: var(--wa-black);
  }

  /* Modal Content Styles */
  .wa-modal-benefit-item {
    display: flex;
    gap: 14px;
    padding: 16px 0;
    border-bottom: 1px solid var(--wa-gray-200);
  }

  .wa-modal-benefit-item:last-child {
    border-bottom: none;
  }

  .wa-modal-benefit-icon {
    width: 48px;
    height: 48px;
    background: var(--wa-gray-100);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .wa-modal-benefit-icon svg {
    width: 24px;
    height: 24px;
    stroke: var(--wa-black);
  }

  .wa-modal-benefit-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .wa-modal-benefit-desc {
    font-size: 0.85rem;
    color: var(--wa-gray-600);
    line-height: 1.5;
    margin: 0;
  }

  .wa-modal-ingredient-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 14px 0;
    border-bottom: 1px solid var(--wa-gray-200);
  }

  .wa-modal-ingredient-item:last-child {
    border-bottom: none;
  }

  .wa-modal-ingredient-name {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .wa-modal-ingredient-benefit {
    font-size: 0.8rem;
    color: var(--wa-gray-600);
  }

  .wa-modal-ingredient-amount {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--wa-black);
    background: var(--wa-gray-100);
    padding: 4px 10px;
    border-radius: 6px;
  }

  .wa-modal-science {
    padding: 16px;
    background: var(--wa-gray-100);
    border-radius: 12px;
  }

  .wa-modal-science-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 12px;
  }

  .wa-modal-science-text {
    font-size: 0.9rem;
    color: var(--wa-gray-700);
    line-height: 1.6;
    margin: 0;
  }

  /* Combinations Tab */
  .wa-modal-combo-item {
    padding: 14px;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .wa-modal-combo-item:last-child {
    margin-bottom: 0;
  }

  .wa-modal-combo-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .wa-modal-combo-product {
    font-size: 1rem;
    font-weight: 700;
    color: var(--wa-black);
  }

  .wa-modal-combo-label {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--wa-white);
    padding: 4px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .wa-modal-combo-benefit {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--wa-gray-800);
    margin-bottom: 6px;
  }

  .wa-modal-combo-detail {
    font-size: 0.8rem;
    color: var(--wa-gray-600);
    line-height: 1.5;
    margin: 0;
  }

  /* Confetti */
  .wa-confetti {
    position: fixed;
    width: 6px;
    height: 6px;
    border-radius: 2px;
    pointer-events: none;
    z-index: 10001;
    animation: confetti-fly 1s ease-out forwards;
  }

  @keyframes confetti-fly {
    to {
      opacity: 0;
      transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0);
    }
  }

  /* Step Indicators */
  .wa-steps {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 4px;
    margin-top: 8px;
  }

  .wa-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    max-width: 60px;
  }

  .wa-steps--mini {
    gap: 8px;
    justify-content: flex-start;
    align-items: center;
    margin: 4px 0 2px 0;
  }

  .wa-steps--mini .wa-step {
    display: block;
    flex: none;
    width: 12px;
    height: 12px;
    max-width: none;
    border-radius: 50%;
    background: var(--wa-gray-300);
    transition: all 0.3s ease;
  }

  .wa-steps--mini .wa-step.active {
    background: #000;
    transform: scale(1.15);
  }

  .wa-step__dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--wa-gray-200);
    border: 3px solid var(--wa-gray-300);
    transition: all 0.3s ease;
  }

  .wa-step.active .wa-step__dot {
    background: #000;
    border-color: #000;
    transform: scale(1.15);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  }

  .wa-step__label {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--wa-gray-400);
    margin-top: 4px;
    transition: color 0.3s ease;
  }

  .wa-step.active .wa-step__label { color: #000; }

  /* Recommendation - v1 style with dashed border */
  .wa-dock__recommendation {
    background: var(--wa-gray-100);
    border: 1px dashed var(--wa-gray-300);
    border-radius: var(--wa-radius-sm);
    padding: 0.75rem;
    margin-bottom: 1rem;
  }

  .wa-dock__recommendation-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--wa-gray-600);
    margin-bottom: 0.5rem;
  }

  .wa-dock__recommendation-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .wa-dock__recommendation-img {
    width: 40px;
    height: 40px;
    border-radius: var(--wa-radius-sm);
    object-fit: cover;
  }

  .wa-dock__recommendation-info {
    flex: 1;
  }

  .wa-dock__recommendation-name {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .wa-dock__recommendation-bundle {
    display: block;
    font-size: 0.7rem;
    color: var(--wa-gray-500);
  }

  .wa-dock__recommendation-add {
    padding: 0.5rem 0.75rem;
    background: var(--wa-black);
    color: var(--wa-white);
    border: none;
    border-radius: var(--wa-radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
  }

  .wa-dock__recommendation-add:hover {
    background: var(--wa-gray-800);
  }

  /* Synergy Explanation, Ritual Guide - Dock */
  .wa-dock__synergy-explanation,
  .wa-dock__ritual {
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
    padding: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.75rem;
  }

  .wa-dock__synergy-explanation {
    background: linear-gradient(135deg, var(--wa-gray-100) 0%, #fafafa 100%);
    border: 1px solid var(--wa-gray-200);
  }

  .wa-dock__synergy {
    margin-bottom: 1rem;
  }

  .wa-dock__synergy-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    margin-bottom: 0.375rem;
  }

  .wa-dock__synergy-header span:first-child { color: var(--wa-gray-500); }
  .wa-dock__synergy-text { font-weight: 600; color: var(--wa-black); }

  /* Dock Pricing */
  .wa-dock__pricing { margin-bottom: 1rem; }

  .wa-dock__price-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    padding: 0.375rem 0;
    color: var(--wa-gray-500);
  }

  .wa-dock__price-row--discount { color: var(--wa-success); }

  .wa-dock__price-row--total {
    font-weight: 700;
    color: var(--wa-black);
    border-top: 1px solid var(--wa-gray-200);
    padding-top: 0.5rem;
    margin-top: 0.25rem;
  }

  /* Discount Steps (Top Section) */
  .wa-dock__discount-steps {
    padding: 12px 16px;
    background: var(--wa-gray-100);
    border-radius: var(--wa-radius-sm);
    margin-bottom: 12px;
  }

  .wa-dock__discount-steps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .wa-dock__discount-steps-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--wa-gray-700);
  }

  .wa-dock__discount-steps-current {
    font-size: 0.75rem;
    font-weight: 700;
    color: #16a34a;
  }

  .wa-steps--top {
    margin-bottom: 8px;
  }

  .wa-dock__discount-hint-text {
    font-size: 0.7rem;
    color: var(--wa-gray-600);
    margin: 0;
    text-align: center;
  }

  .wa-dock__discount-hint-text strong {
    color: #16a34a;
    font-weight: 600;
  }

  /* Sticky Checkout Footer */
  .wa-dock__checkout-footer {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 12px 12px 20px;
    background: var(--wa-white);
    border-top: 1px solid var(--wa-gray-200);
    margin: 0 -16px -24px -16px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
  }

  .wa-dock--expanded .wa-dock__checkout-footer {
    display: flex;
  }

  .wa-dock__checkout-total {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    min-width: 80px;
  }

  .wa-dock__checkout-total-label {
    font-size: 0.65rem;
    color: var(--wa-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .wa-dock__checkout-total-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--wa-black);
  }

  .wa-dock__checkout-btn {
    height: 48px;
    padding: 0 24px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: var(--wa-white);
    border: none;
    border-radius: var(--wa-radius-sm);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.35);
    transition: all 0.2s ease;
    flex-shrink: 0;
    flex-grow: 1;
    max-width: 200px;
  }

  .wa-dock__checkout-btn:disabled {
    background: var(--wa-gray-300);
    cursor: not-allowed;
    box-shadow: none;
  }

  .wa-dock__checkout-btn:not(:disabled):hover {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.45);
    transform: translateY(-1px);
  }

  .wa-dock__checkout-btn:not(:disabled):active {
    transform: translateY(0);
  }

  /* Flying Ghost & Particles */
  .wa-flying-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    border-radius: var(--wa-radius-sm);
    box-shadow: var(--wa-shadow-lg);
  }

  .wa-particles {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
  }

  .wa-particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--wa-black);
    border-radius: 50%;
    animation: particleFly 0.8s ease-out forwards;
  }

  @keyframes particleFly {
    to {
      opacity: 0;
      transform: translate(var(--tx), var(--ty)) scale(0);
    }
  }

  /* ========== DESKTOP ========== */
  @media (min-width: 768px) {
    .wellness-architect { padding: 3rem 2rem; }
    .wa-header__title { font-size: 2.25rem; }

    .wa-container {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 2rem;
      align-items: start;
    }

    .wa-products {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    /* 2+2+1 layout: last item centered */
    .wa-products .wa-product-card:last-child:nth-child(odd) {
      grid-column: 1 / -1;
      max-width: 50%;
      justify-self: center;
    }

    .wa-product-card__title { font-size: 0.85rem; }

    /* Bigger hexagon on desktop */
    .wa-synergy-map__svg {
      height: 260px;
    }
    .wa-dock { display: none; }

    .wa-sidebar {
      display: block;
      position: sticky;
      top: 20px;
      background: var(--wa-white);
      border: 1px solid var(--wa-gray-200);
      border-radius: var(--wa-radius);
      padding: 1.25rem;
    }

    .wa-sidebar__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .wa-sidebar__title { font-size: 1rem; font-weight: 600; margin: 0; }
    .wa-sidebar__count { font-size: 0.75rem; color: var(--wa-gray-500); }

    .wa-sidebar__items-container { min-height: 100px; margin-bottom: 1rem; }

    .wa-sidebar__empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      color: var(--wa-gray-400);
      text-align: center;
    }

    .wa-sidebar__empty-state p { margin: 0.75rem 0 0; font-size: 0.8rem; line-height: 1.4; }
    .wa-sidebar--has-items .wa-sidebar__empty-state { display: none; }

    .wa-sidebar__items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .wa-sidebar__item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--wa-gray-100);
      border-radius: var(--wa-radius-sm);
    }

    .wa-sidebar__item-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: inherit;
      flex: 1;
      min-width: 0;
    }

    .wa-sidebar__item-image {
      width: 48px;
      height: 48px;
      border-radius: var(--wa-radius-sm);
      object-fit: cover;
    }

    .wa-sidebar__item-info { flex: 1; min-width: 0; }
    .wa-sidebar__item-title { font-size: 0.85rem; font-weight: 600; margin: 0 0 0.125rem; }
    .wa-sidebar__item-benefit { font-size: 0.65rem; color: var(--wa-gray-600); margin: 0; font-weight: 500; }

    .wa-sidebar__item-controls { display: flex; align-items: center; gap: 0.5rem; }

    .wa-sidebar__item-qty {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: var(--wa-white);
      border-radius: 6px;
      padding: 0.25rem;
    }

    .wa-sidebar__item-qty-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: none;
      background: transparent;
      color: var(--wa-gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
    }

    .wa-sidebar__item-qty-btn:hover { background: var(--wa-gray-200); }
    .wa-sidebar__item-qty-value { min-width: 20px; text-align: center; font-size: 0.8rem; font-weight: 600; }

    .wa-sidebar__item-remove {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--wa-gray-400);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wa-sidebar__item-remove:hover { background: #fee2e2; color: #ef4444; }

    /* Sidebar Boxes */
    .wa-recommendation,
    .wa-synergy-explanation,
    .wa-ritual-guide {
      background: var(--wa-gray-100);
      border-radius: var(--wa-radius-sm);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .wa-synergy-explanation {
      background: linear-gradient(135deg, var(--wa-gray-100) 0%, #fafafa 100%);
      border: 1px solid var(--wa-gray-200);
    }

    .wa-recommendation { border: 1px dashed var(--wa-gray-300); }

    .wa-recommendation__header,
    .wa-ritual-guide__header {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--wa-gray-600);
      margin-bottom: 0.75rem;
    }

    .wa-recommendation__product {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .wa-recommendation__image {
      width: 48px;
      height: 48px;
      border-radius: var(--wa-radius-sm);
      object-fit: cover;
    }

    .wa-recommendation__info { flex: 1; }
    .wa-recommendation__label { display: block; font-size: 0.65rem; text-transform: uppercase; color: var(--wa-gray-500); margin-bottom: 0.125rem; }
    .wa-recommendation__name { display: block; font-size: 0.9rem; font-weight: 600; color: var(--wa-black); }

    .wa-recommendation__bundle-name {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.375rem 0.625rem;
      background: var(--wa-white);
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    .wa-recommendation__reason { font-size: 0.75rem; color: var(--wa-gray-600); line-height: 1.4; margin: 0 0 0.75rem; }

    .wa-recommendation__add-btn {
      width: 100%;
      padding: 0.625rem;
      background: var(--wa-black);
      color: var(--wa-white);
      border: none;
      border-radius: var(--wa-radius-sm);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      font-family: inherit;
    }

    .wa-recommendation__add-btn:hover { background: var(--wa-gray-800); }

    .wa-ritual-guide__content { font-size: 0.8rem; }

    .wa-ritual-guide__item {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--wa-gray-200);
    }

    .wa-ritual-guide__item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .wa-ritual-guide__time { font-weight: 600; color: var(--wa-black); min-width: 55px; }
    .wa-ritual-guide__text { color: var(--wa-gray-600); line-height: 1.4; }
    .wa-ritual-guide__product { font-weight: 600; color: var(--wa-black); }

    /* Sidebar Synergy */
    .wa-sidebar__synergy { margin-bottom: 1rem; }

    .wa-sidebar__synergy-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .wa-sidebar__synergy-header span:first-child { color: var(--wa-gray-500); }
    .wa-sidebar__synergy-text { font-weight: 600; color: var(--wa-black); }

    /* Sidebar Pricing */
    .wa-sidebar__pricing { margin-bottom: 1rem; }

    .wa-sidebar__price-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      padding: 0.5rem 0;
      color: var(--wa-gray-500);
    }

    .wa-sidebar__price-row--discount { color: var(--wa-success); }

    .wa-sidebar__price-row--total {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--wa-black);
      border-top: 1px solid var(--wa-gray-200);
      padding-top: 0.75rem;
      margin-top: 0.25rem;
    }

    .wa-sidebar__checkout-btn {
      width: 100%;
      height: 48px;
      background: var(--wa-black);
      color: var(--wa-white);
      border: none;
      border-radius: var(--wa-radius-sm);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--wa-transition);
      font-family: inherit;
    }

    .wa-sidebar__checkout-btn:hover:not(:disabled) { background: var(--wa-gray-800); }
    .wa-sidebar__checkout-btn:disabled { background: var(--wa-gray-300); cursor: not-allowed; }
  }

  @media (min-width: 1024px) {
    .wa-container { grid-template-columns: 1fr 400px; gap: 2.5rem; }
  }
</style>

<script>
(function() {
  'use strict';

  // ============================================
  // ICON REGISTRY (DRY)
  // ============================================
  const ICONS = {
    close: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
    lightning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>',
    clock: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
    star: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path></svg>',
    lock: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>',
    unlock: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 019.9-1"></path></svg>',
    moon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>',
    sun: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>',
    sparkle: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M3 12h18M5.6 5.6l12.8 12.8M18.4 5.6L5.6 18.4"></path></svg>',
    trophy: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 22V8a4 4 0 0 1 8 0v14"></path></svg>'
  };

  // ============================================
  // EXTENDED PRODUCT DATA (v2 - cyrasoul.com data)
  // ============================================
  const EXTENDED_PRODUCT_DATA = {
    'dreamglow': {
      name: 'DreamGlow',
      timing: 'Yatmadan √∂nce tok karnƒ±na 1 √∂l√ßek (10gr)',
      category: 'night',
      benefits: [
        { icon: 'sparkle', title: 'G√ºzellik Uykusu', description: 'Uykunuzun her anƒ±nƒ± cildiniz i√ßin bir yenilenme seansƒ±na d√∂n√º≈üt√ºr√ºr. Siz dinlenirken hedefe y√∂nelik i√ßerikler cildin doƒüal onarƒ±m s√ºrecini destekler.' },
        { icon: 'moon', title: 'Uyku Kalitesi', description: 'Yataƒüa yattƒ±ƒüƒ±nda uyumakta zorlanƒ±yorsan veya 8 saat uyusan bile yorgun uyanƒ±yorsan, DreamGlow zihni sakinle≈ütirerek kaliteli uykuya ge√ßi≈üi kolayla≈ütƒ±rƒ±r.' },
        { icon: 'droplet', title: 'Cilt Yenilenmesi', description: 'Yetersiz uyku cildin kendini onarma d√∂ng√ºs√ºn√º %60\'a kadar yava≈ülatƒ±r. DreamGlow kolajen √ºretimini destekleyerek mat, donuk g√∂r√ºn√ºme son verir.' }
      ],
      ingredients: [
        { name: 'Kollajen Peptit (Tip 1 & Tip 3)', amount: '5000 mg', benefit: 'Cilt elastikiyeti ve sƒ±kƒ±lƒ±k desteƒüi' },
        { name: 'Melisa Ekstresi', amount: '500 mg', benefit: 'Zihni sakinle≈ütirerek uyku hazƒ±rlƒ±ƒüƒ±' },
        { name: 'Mayƒ±s Papatyasƒ± Ekstresi', amount: '400 mg', benefit: 'Sinir sistemini yatƒ±≈ütƒ±rƒ±r, gev≈üeme saƒülar' },
        { name: 'Hyaluronik Asit', amount: '200 mg', benefit: 'Yoƒüun nem desteƒüi, cilt dolgunluƒüu' },
        { name: 'L-Teanin', amount: '150 mg', benefit: 'Derin uykuya ge√ßi≈üi kolayla≈ütƒ±rƒ±r' },
        { name: 'C Vitamini (Sodyum L-Askorbat)', amount: '69,47 mg', benefit: 'Antioksidan koruma, kolajen sentezi' }
      ],
      science: {
        title: 'Nasƒ±l √áalƒ±≈üƒ±r?',
        description: 'Ara≈ütƒ±rmalar, yetersiz uykunun cildin kendini onarma d√∂ng√ºs√ºn√º %60\'a kadar yava≈ülattƒ±ƒüƒ±nƒ± g√∂steriyor (Journal of Clinical Sleep Medicine, 2020). DreamGlow, uykunuzun her anƒ±nƒ± cildiniz i√ßin yenilenme seansƒ±na d√∂n√º≈üt√ºr√ºr. Su, smoothie, mocktail veya yemeklerle kolayca t√ºketebilirsiniz. Doƒüal vanilya aromasƒ± i√ßerir. Sƒ±ƒüƒ±r kolajeni i√ßermektedir.'
      }
    },
    'dailyglow': {
      name: 'DailyGlow',
      timing: 'Sabah tok karnƒ±na 1 kaps√ºl',
      category: 'morning',
      benefits: [
        { icon: 'sun', title: 'Doƒüal Parlaklƒ±k', description: 'Neden bazƒ±larƒ±nƒ±n cildi makyajsƒ±zken bile parlar? Cevap genetik deƒüil, h√ºcre seviyesinde doƒüru beslenme. DailyGlow i√ßeriden ƒ±≈üƒ±ldayan bir cilt i√ßin g√ºnl√ºk antioksidan g√ºc√ºn.' },
        { icon: 'shield', title: 'Serbest Radikal Korumasƒ±', description: 'Hava kirliliƒüi, stres, g√ºne≈ü ƒ±≈üƒ±nlarƒ± ve ekranlarƒ±n mavi ƒ±≈üƒ±ƒüƒ± ciltte serbest radikaller olu≈üturur. DailyGlow bunlarƒ± i√ßeriden n√∂tralize eder.' },
        { icon: 'lightning', title: 'G√ºn Boyu Enerji', description: 'Kƒ±rmƒ±zƒ± Kore ginsengi ile kan dola≈üƒ±mƒ±nƒ± ve oksijen akƒ±≈üƒ±nƒ± destekler. Cildin ne kadar uyusan da yorgun g√∂r√ºn√ºyorsa, DailyGlow eksik par√ßan.' }
      ],
      ingredients: [
        { name: 'MSM (Metils√ºlfonilmetan)', amount: '500 mg', benefit: 'Kolajen √ºretiminin temel hammaddesi, esneklik ve p√ºr√ºzs√ºzl√ºk' },
        { name: '√áinko', amount: '104,55 mg', benefit: 'Cilt saƒülƒ±ƒüƒ± ve baƒüƒ±≈üƒ±klƒ±k desteƒüi' },
        { name: 'Kƒ±rmƒ±zƒ± Kore Ginsengi Ekstresi', amount: '100 mg', benefit: 'Kan dola≈üƒ±mƒ±nƒ± ve oksijen akƒ±≈üƒ±nƒ± destekler' },
        { name: 'Nikotinamid (B3 Vitamini)', amount: '50 mg', benefit: 'Cilt bariyerini g√º√ßlendirir, nemi hapseder' },
        { name: 'Manganez Glukonat', amount: '2,5 mg', benefit: 'Antioksidan enzim aktivasyonu' },
        { name: 'L-Selenometionin', amount: '21 ¬µg', benefit: 'G√º√ßl√º antioksidan, h√ºcre korumasƒ±' }
      ],
      science: {
        title: 'Nasƒ±l √áalƒ±≈üƒ±r?',
        description: 'Modern hayatƒ±n ger√ßeƒüi: Hava kirliliƒüi, stres ve ekranlarƒ±n mavi ƒ±≈üƒ±ƒüƒ± ciltte "serbest radikaller" olu≈üturur. Bu matla≈üma, lekeleme ve erken ya≈ülanmaya yol a√ßar. DailyGlow, v√ºcudun en g√º√ßl√º antioksidanlarƒ±yla serbest radikalleri n√∂tralize eder. Sadece bug√ºn deƒüil, gelecekteki cildine yapƒ±lmƒ±≈ü bir yatƒ±rƒ±mdƒ±r. G√ºnd√ºz alƒ±nmasƒ± √∂nerilir.'
      }
    },
    'mindfuel': {
      name: 'MindFuel',
      timing: 'G√ºn i√ßinde tok karnƒ±na 2 kaps√ºl',
      category: 'morning',
      benefits: [
        { icon: 'brain', title: 'Zihinsel Yakƒ±t', description: 'Zihninin sisli ve yava≈ü olduƒüunu hissettiƒüin oluyor mu? Potansiyelinin orada olduƒüunu biliyorsun ama ula≈üamƒ±yorsun. MindFuel i≈üte o zihinsel yakƒ±tƒ± saƒülar.' },
        { icon: 'lightning', title: 'Dikkat & Odaklanma', description: '√ñnemli i≈üin ba≈üƒ±na oturduƒüunda d√º≈ü√ºncelerini toparlayamƒ±yorsan, yapƒ±lacaklar listesi g√∂z√ºnde b√ºy√ºyorsa, MindFuel g√ºn i√ßindeki gizli g√ºc√ºn olabilir.' },
        { icon: 'clock', title: 'G√ºn Ortasƒ± Enerjisi', description: 'G√ºn ortasƒ±nda enerjin d√º≈ü√ºyor ve kahve √ß√∂z√ºm olmuyorsa, MindFuel doƒüal enerji ile dikkat daƒüƒ±nƒ±klƒ±ƒüƒ±nƒ± azaltƒ±r.' }
      ],
      ingredients: [
        { name: 'Lepidyum Meyenii (Maca) Ekstresi', amount: '500 mg', benefit: 'Zihinsel dayanƒ±klƒ±lƒ±k ve enerji artƒ±rƒ±mƒ±' },
        { name: 'L-Tirozin', amount: '250 mg', benefit: 'N√∂rotransmitter yapƒ± ta≈üƒ±, motivasyon ve stres y√∂netimi' },
        { name: 'Kƒ±rmƒ±zƒ± Kore Ginsengi Ekstresi', amount: '200 mg', benefit: 'Bili≈üsel performans ve enerji desteƒüi' },
        { name: 'Ginkgo Biloba Ekstresi', amount: '115 mg', benefit: 'Beyne kan akƒ±≈üƒ± ve oksijenlenme desteƒüi' },
        { name: 'B12 Vitamini (Metilkobalamin)', amount: '500 ¬µg', benefit: 'Sinir sistemi enerji desteƒüi, hafƒ±za yardƒ±mcƒ±sƒ±' }
      ],
      science: {
        title: 'Nasƒ±l √áalƒ±≈üƒ±r?',
        description: 'Tƒ±pkƒ± bedenin gibi, zihninin de en iyi performans i√ßin doƒüru yakƒ±ta ihtiyacƒ± var. MindFuel dikkatinin daƒüƒ±ldƒ±ƒüƒ±, enerjinin d√º≈üt√ºƒü√º anlarda zihnini canlandƒ±rƒ±r. Sadece "√ßalƒ±≈ümak" deƒüil, ger√ßekten "i≈ü bitirmek" ve g√ºn sonunda tatmin olmak istiyorsan, MindFuel potansiyelini kullanmana destek olur.'
      }
    },
    'thechill': {
      name: 'TheChill',
      timing: 'Tok karnƒ±na 2 kaps√ºl',
      category: 'night',
      benefits: [
        { icon: 'peace', title: 'Stres Y√∂netimi', description: 'Neden en basit aksilikler bile b√ºy√ºk stres kaynaƒüƒ±na d√∂n√º≈ü√ºr? Cevap irade g√ºc√ºnde deƒüil, modern hayatƒ±n sinir sistemimiz √ºzerindeki etkisinde.' },
        { icon: 'brain', title: 'Kortizol Dengesi', description: 'S√ºrekli bildirimler ve sorumluluklar beyni "sava≈ü ya da ka√ß" modunda tutar. TheChill kortizol seviyelerini dengeleyerek bu d√∂ng√ºy√º kƒ±rar.' },
        { icon: 'muscle', title: 'Zihinsel Huzur', description: 'Toplantƒ±dan toplantƒ±ya ko≈üarken zihnin durmuyorsa, en ufak aksilikte sabrƒ±n t√ºkeniyorsa, TheChill senin ki≈üisel denge noktan.' }
      ],
      ingredients: [
        { name: 'Rhodiola Ekstresi', amount: '300 mg', benefit: 'Stres tepkilerini dengeler, zihinsel yorgunlukla sava≈üƒ±r' },
        { name: 'Mayƒ±s Papatyasƒ± Ekstresi', amount: '200 mg', benefit: 'Sinir sistemini yatƒ±≈ütƒ±rƒ±r, sakinlik saƒülar' },
        { name: 'Melisa Ekstresi', amount: '200 mg', benefit: 'Doƒüal gev≈üeme, anda kalmanƒ±za destek' },
        { name: '√áarkƒ±felek (Passiflora) Ekstresi', amount: '150 mg', benefit: 'Anksiyete azaltma, huzurlu his' },
        { name: 'B6 Vitamini (Piridoksin)', amount: '10 mg', benefit: 'Serotonin √ºretimine katkƒ±' },
        { name: 'B12 Vitamini (Metilkobalamin)', amount: '500 ¬µg', benefit: 'Sinir sistemi desteƒüi, ruh hali dengesi' }
      ],
      science: {
        title: 'Nasƒ±l √áalƒ±≈üƒ±r?',
        description: 'Modern hayatƒ±n temposu s√ºrekli gerginlik, sabƒ±rsƒ±zlƒ±k ve zihinsel yorgunluƒüa neden olur. TheChill form√ºl√º bu yƒ±pratƒ±cƒ± d√∂ng√ºy√º kƒ±rmak i√ßin tasarlandƒ±. ƒ∞√ßeriƒüindeki g√º√ßl√º adaptojenler sinir sisteminin sakinle≈ümesine, kortizol seviyelerinin dengelenmesine ve zihninin huzura kavu≈ümasƒ±na destek olur. Sen g√ºne devam ederken...'
      }
    },
    'reset-button': {
      name: 'Reset Button',
      timing: 'Tok karnƒ±na 2 kaps√ºl',
      category: 'noon',
      benefits: [
        { icon: 'refresh', title: '5\'li S√ºper Form√ºl', description: 'Piyasadaki standart √ºr√ºnlerin aksine, v√ºcudun t√ºm arƒ±nma mekanizmalarƒ±nƒ± (Karaciƒüer, B√∂brekler, H√ºcresel) aynƒ± anda hedefler.' },
        { icon: 'liver', title: 'Doƒüal Filtre', description: '200 mg Enginar ve 150 mg Devedikeni ile karaciƒüer dostu maksimum destek. Toksinleri s√ºzme kapasitesini artƒ±rƒ±r.' },
        { icon: 'energy', title: 'Canlƒ±lƒ±k & Hafiflik', description: 'Genel yorgunluk, aƒüƒ±rlƒ±k hissi, ≈üi≈ükinlik ya≈üƒ±yorsan, Reset Button bedenini yoran toksinleri geride bƒ±rakmanƒ± saƒülar.' }
      ],
      ingredients: [
        { name: 'Karahindiba Ekstresi', amount: '200 mg', benefit: 'Sƒ±vƒ± dengesi, √∂dem atma, doƒüal di√ºretik etki' },
        { name: 'Enginar Ekstresi', amount: '200 mg', benefit: 'Karaciƒüer desteƒüi, safra akƒ±≈üƒ±nƒ± d√ºzenler' },
        { name: 'Devedikeni Ekstresi', amount: '150 mg', benefit: 'Karaciƒüer koruma, toksin filtreleme' },
        { name: 'Moringa Ekstresi', amount: '150 mg', benefit: 'Antioksidan, mineral desteƒüi, enerji' },
        { name: 'Zerde√ßal Ekstresi', amount: '150 mg', benefit: 'Antienflamatuar, antioksidan koruma' }
      ],
      science: {
        title: 'Nasƒ±l √áalƒ±≈üƒ±r?',
        description: 'Modern hayatƒ±n temposu, i≈ülenmi≈ü gƒ±dalar ve sosyal ya≈üamƒ±n y√ºkleri v√ºcudun doƒüal dengesini bozar. Reset Button bu dengeyi yeniden kurmak i√ßin geli≈ütirildi. Doƒüal Filtre (Enginar + Devedikeni), Sƒ±vƒ± Dengesi (Karahindiba) ve Canlƒ±lƒ±k Kaynaƒüƒ± (Moringa + Zerde√ßal) ile bedenini yoran toksinleri geride bƒ±rak, g√ºne temiz bir sayfa a√ß.'
      }
    }
  };

  // ============================================
  // SYNERGY DATA
  // ============================================
  const SYNERGY_MAP = {
    'dreamglow': { name: 'DreamGlow', timing: 'Yatmadan √∂nce', benefit: 'Cilt Onarƒ±mƒ± & Kolajen', shortDesc: 'Gece Cilt Rit√ºeli', tip: '1 √∂l√ßek tozu ƒ±lƒ±k suyla karƒ±≈ütƒ±rƒ±n.', category: 'night' },
    'dailyglow': { name: 'DailyGlow', timing: 'Sabah tok karnƒ±na', benefit: 'Cilt Parlaklƒ±ƒüƒ± & Enerji', shortDesc: 'G√ºnd√ºz I≈üƒ±ltƒ± Desteƒüi', tip: 'Tok karnƒ±na 1 kaps√ºl. I≈üƒ±ltƒ± i√ßeriden ba≈ülar.', category: 'morning' },
    'mindfuel': { name: 'MindFuel', timing: 'G√ºn i√ßinde tok karnƒ±na', benefit: 'Odak & Zihinsel Performans', shortDesc: 'Bili≈üsel G√º√ß Desteƒüi', tip: 'Tok karnƒ±na 2 kaps√ºl. Kahveden etkili odaklanma.', category: 'morning' },
    'thechill': { name: 'TheChill', timing: 'Ak≈üam tok karnƒ±na', benefit: 'Stres Y√∂netimi & Rahatlama', shortDesc: 'Huzurlu Ak≈üam Desteƒüi', tip: 'Ak≈üam tok karnƒ±na 2 kaps√ºl.', category: 'night' },
    'reset-button': { name: 'Reset Button', timing: 'Tok karnƒ±na', benefit: 'Arƒ±nma & Karaciƒüer Desteƒüi', shortDesc: 'Bedensel Arƒ±nma', tip: 'Bol su ile tok karnƒ±na 2 kaps√ºl.', category: 'noon' }
  };

  const SYNERGY_CONNECTIONS = {
    'dailyglow+dreamglow': { label: '24 Saat Cilt', strength: 'strong', color: '#8B5CF6', icon: '‚ú®' },
    'dailyglow+mindfuel': { label: 'Power Morning', strength: 'strong', color: '#3B82F6', icon: '‚ö°' },
    'dailyglow+reset-button': { label: 'Detox & Glow', strength: 'medium', color: '#10B981', icon: 'üåø' },
    'dailyglow+thechill': { label: 'Denge Paketi', strength: 'medium', color: '#6366F1', icon: '‚öñÔ∏è' },
    'dreamglow+mindfuel': { label: 'Smart Beauty', strength: 'medium', color: '#EC4899', icon: 'üíé' },
    'dreamglow+reset-button': { label: 'Gece Terapisi', strength: 'medium', color: '#8B5CF6', icon: 'üåô' },
    'dreamglow+thechill': { label: 'Uyku Rit√ºeli', strength: 'strong', color: '#6366F1', icon: 'üò¥' },
    'mindfuel+reset-button': { label: 'Berrak Zihin', strength: 'medium', color: '#14B8A6', icon: 'üß†' },
    'mindfuel+thechill': { label: 'Zen Performans', strength: 'strong', color: '#10B981', icon: 'üßò' },
    'reset-button+thechill': { label: 'Tam Reset', strength: 'medium', color: '#F59E0B', icon: 'üîÑ' }
  };

  const SYNERGY_EXPLANATIONS = {
    'dailyglow+dreamglow': { title: '7/24 G√ºzellik Kiti', benefit: 'Kesintisiz cilt onarƒ±mƒ±', detail: 'G√ºnd√ºz cildinizi koruyun, gece uykuda onarƒ±n.' },
    'dailyglow+mindfuel': { title: 'Power Morning', benefit: 'Enerji + Odaklanma', detail: 'Hem fiziksel ƒ±≈üƒ±ltƒ± hem zihinsel netlik.' },
    'dailyglow+reset-button': { title: 'Detox & Glow', benefit: 'Arƒ±nma + Canlƒ±lƒ±k', detail: 'ƒ∞√ßeriden temizlenin, dƒ±≈üarƒ±ya ƒ±≈üƒ±k sa√ßƒ±n.' },
    'dailyglow+thechill': { title: 'Denge Paketi', benefit: 'Sabah Enerjisi, Ak≈üam Huzuru', detail: 'Modern hayatƒ±n panzehiri.' },
    'dreamglow+mindfuel': { title: 'Smart & Beautiful', benefit: 'G√ºnd√ºz Odak, Gece Bakƒ±m', detail: 'Ne g√∂r√ºn√ºm√ºn√ºzden ne ba≈üarƒ±nƒ±zdan √∂d√ºn vermeyin.' },
    'dreamglow+reset-button': { title: 'Gece Terapisi', benefit: 'Arƒ±nma + Yenilenme', detail: 'Siz uyurken bedeniniz toksinleri atsƒ±n.' },
    'dreamglow+thechill': { title: 'Uyku Rit√ºeli', benefit: 'Derin Uyku + Onarƒ±m', detail: 'TheChill zihni susturur, DreamGlow bedeni onarƒ±r.' },
    'mindfuel+reset-button': { title: 'Berrak Zihin', benefit: 'Toksin Atƒ±mƒ± + Konsantrasyon', detail: 'Beyin sisine son. Arƒ±nmƒ±≈ü metabolizma ile performans.' },
    'mindfuel+thechill': { title: 'Zen Performans', benefit: 'Kontroll√º G√º√ß', detail: 'Stres yapmadan odaklanƒ±n.' },
    'reset-button+thechill': { title: 'Tam Reset', benefit: 'Zihinsel & Bedensel Arƒ±nma', detail: 'Fabrika Ayarlarƒ±na D√∂n√º≈ü.' },
    'dailyglow+dreamglow+mindfuel': { title: 'CEO Paketi', benefit: 'G√∂r√ºn√ºm + Zeka + Enerji', detail: 'Profesyoneller i√ßin tasarlandƒ±.' },
    'dailyglow+dreamglow+thechill': { title: 'Stress-Free Beauty', benefit: 'Stres Kar≈üƒ±tƒ± G√ºzellik', detail: 'En pop√ºler √º√ßl√ºm√ºz.' },
    'mindfuel+reset-button+thechill': { title: 'Zihinsel Berraklƒ±k', benefit: 'Arƒ±nma + Odak + Denge', detail: 'Temiz beden, berrak zihin.' },
    'dailyglow+dreamglow+mindfuel+thechill': { title: 'Premium Wellness', benefit: '%25 ƒ∞ndirim', detail: 'L√ºks bir ya≈üam tarzƒ±nƒ±n temeli.' },
    'dailyglow+dreamglow+mindfuel+reset-button+thechill': { title: 'The Cyrasoul Ritual', benefit: '%30 ƒ∞ndirim - TAM DONANIM', detail: 'B√ºt√ºnc√ºl iyilik hali i√ßin eksiksiz set.' }
  };

  const SINGLE_PRODUCT_BENEFITS = {
    'dreamglow': { title: 'DreamGlow', benefit: 'Gece cilt onarƒ±m desteƒüi', detail: 'Uyku sƒ±rasƒ±nda kolajen √ºretimini ve cilt yenilenmesini destekler.' },
    'dailyglow': { title: 'DailyGlow', benefit: 'G√ºnd√ºz enerji ve cilt desteƒüi', detail: 'H√ºcresel enerji √ºretimini destekler, cildi dƒ±≈ü fakt√∂rlere kar≈üƒ± korur.' },
    'mindfuel': { title: 'MindFuel', benefit: 'Odaklanma ve konsantrasyon desteƒüi', detail: 'Zihinsel berraklƒ±ƒüƒ± ve odaklanmayƒ± destekler.' },
    'thechill': { title: 'TheChill', benefit: 'Sakinlik ve rahatlama desteƒüi', detail: 'Stresi azaltmaya ve zihinsel sakinliƒüi desteklemeye yardƒ±mcƒ± olur.' },
    'reset-button': { title: 'Reset Button', benefit: 'Detoks ve arƒ±nma desteƒüi', detail: 'Karaciƒüer fonksiyonlarƒ±nƒ± destekler, toksin atƒ±mƒ±na yardƒ±mcƒ± olur.' }
  };

  const RECOMMENDATIONS = {
    'dreamglow': [
      { handle: 'dailyglow', bundle: '7/24 G√ºzellik', reason: 'Gece onarƒ±mƒ±na g√ºnd√ºz korumasƒ±nƒ± ekleyin.' },
      { handle: 'thechill', bundle: 'Derin Uyku Rit√ºeli', reason: 'Zihni sakinle≈ütirin ki g√ºzellik uykunuz b√∂l√ºnmesin.' }
    ],
    'dailyglow': [
      { handle: 'dreamglow', bundle: 'Gece & G√ºnd√ºz', reason: '24 saat s√ºren kesintisiz cilt desteƒüi.' },
      { handle: 'mindfuel', bundle: 'Start-Up Enerjisi', reason: 'Hem cildiniz hem zihniniz g√ºne hazƒ±r olsun.' }
    ],
    'mindfuel': [
      { handle: 'thechill', bundle: 'Flow State', reason: 'G√ºnd√ºz keskin zihin, ak≈üam huzurlu dinginlik.' },
      { handle: 'reset-button', bundle: 'Berrak Zihin', reason: 'Toksinlerden arƒ±nmƒ±≈ü beden, daha net d√º≈ü√ºn√ºr.' }
    ],
    'thechill': [
      { handle: 'mindfuel', bundle: 'Denge Ustasƒ±', reason: 'Stres yok, sadece odaklanma ve sakinlik.' },
      { handle: 'dreamglow', bundle: 'Huzurlu Gece', reason: 'Sakin zihinle yataƒüƒ±n girin, yenilenmi≈ü uyanƒ±n.' }
    ],
    'reset-button': [
      { handle: 'dailyglow', bundle: 'Temiz Ba≈ülangƒ±√ß', reason: 'Arƒ±nmƒ±≈ü bedenin √ºzerine cilt ƒ±≈üƒ±ltƒ±sƒ±nƒ± ekleyin.' },
      { handle: 'thechill', bundle: 'B√ºt√ºnsel Hafiflik', reason: 'Bedensel detoks ve zihinsel rahatlama bir arada.' }
    ]
  };

  const SYNERGY_CONFIG = {
    1: { percent: 20, text: 'Ba≈ülangƒ±√ß', discount: 0 },
    2: { percent: 40, text: '%15 ƒ∞kili G√º√ß', discount: 0.15 },
    3: { percent: 60, text: '%20 Pop√ºler', discount: 0.20 },
    4: { percent: 80, text: '%25 Pro', discount: 0.25 },
    5: { percent: 100, text: '%30 Efsane', discount: 0.30 }
  };

  // ============================================
  // ACHIEVEMENTS (v2)
  // ============================================
  const ACHIEVEMENTS = {
    'first-step': { id: 'first-step', title: 'ƒ∞lk Adƒ±m', emoji: 'üå±', description: 'ƒ∞lk √ºr√ºn√ºn√º ekleyerek wellness yolculuƒüuna ba≈üladƒ±nƒ±z!', icon: 'star', condition: s => s.items.length >= 1 },
    'power-duo': { id: 'power-duo', title: 'G√º√ßl√º ƒ∞kili', emoji: '‚ö°', description: 'ƒ∞ki √ºr√ºn birlikte %15 sinerji indirimi kazandƒ±nƒ±z!', icon: 'lightning', condition: s => s.items.length >= 2 },
    'triple-threat': { id: 'triple-threat', title: '√ú√ßl√º Kuvvet', emoji: 'üî•', description: '√ú√ß √ºr√ºnle rit√ºelinizi g√º√ßlendirdiniz. %20 indirim!', icon: 'fire', condition: s => s.items.length >= 3 },
    'ritual-master': { id: 'ritual-master', title: 'Rit√ºel Ustasƒ±', emoji: '‚ú®', description: 'D√∂rt √ºr√ºnle tam bir g√ºnl√ºk rit√ºel olu≈üturuyorsunuz. %25 indirim!', icon: 'sparkle', condition: s => s.items.length >= 4 },
    'wellness-architect': { id: 'wellness-architect', title: 'Wellness Architect', emoji: 'üèÜ', description: 'T√ºm 5 √ºr√ºn√º eklediniz! Maksimum %30 sinerji indirimi!', icon: 'trophy', condition: s => s.items.length >= 5 }
  };

  const achievementState = { unlocked: new Set(), pending: [] };

  function hasProducts(state, handles) {
    const itemHandles = state.items.map(i => matchHandle(i.title));
    return handles.every(h => itemHandles.includes(h));
  }

  // ============================================
  // STATE
  // ============================================
  const state = {
    items: [],
    isExpanded: false,
    isMobile: window.innerWidth < 768
  };

  // ============================================
  // DOM ELEMENTS
  // ============================================
  const section = document.getElementById('wellness-architect');
  if (!section) return;

  const productCards = section.querySelectorAll('.wa-product-card');
  const dock = section.querySelector('.wa-dock');
  const sidebar = section.querySelector('.wa-sidebar');
  const particles = section.querySelector('.wa-particles');

  // Cached recommendation elements (v1 approach for performance)
  const dockRecElements = {
    container: dock?.querySelector('.wa-dock__recommendation'),
    img: dock?.querySelector('.wa-dock__recommendation-img'),
    name: dock?.querySelector('.wa-dock__recommendation-name'),
    bundle: dock?.querySelector('.wa-dock__recommendation-bundle'),
    addBtn: dock?.querySelector('.wa-dock__recommendation-add')
  };
  const sidebarRecElements = {
    container: sidebar?.querySelector('.wa-recommendation'),
    img: sidebar?.querySelector('.wa-recommendation__image'),
    name: sidebar?.querySelector('.wa-recommendation__name'),
    bundleName: sidebar?.querySelector('.wa-recommendation__bundle-name'),
    reason: sidebar?.querySelector('.wa-recommendation__reason'),
    addBtn: sidebar?.querySelector('.wa-recommendation__add-btn')
  };

  // ============================================
  // HELPERS
  // ============================================
  const MONEY_FORMATTER = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 0 });
  const formatMoney = cents => MONEY_FORMATTER.format(cents / 100);
  const vibrate = (pattern = 10) => { if ('vibrate' in navigator) navigator.vibrate(pattern); };

  function matchHandle(title) {
    const normalized = title.toLowerCase().replace(/[^a-z0-9]/g, '');
    const handles = ['dreamglow', 'dailyglow', 'mindfuel', 'thechill', 'resetbutton'];
    for (const h of handles) {
      if (normalized.includes(h.replace('-', ''))) return h === 'resetbutton' ? 'reset-button' : h;
    }
    return normalized;
  }

  function getTotalQuantity() {
    return state.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
  }

  // Flying ghost animation (v1 approach)
  function createFlyingGhost(sourceEl, targetEl, imageSrc) {
    if (!sourceEl || !targetEl) return Promise.resolve();

    const sourceRect = sourceEl.getBoundingClientRect();
    const targetRect = targetEl.getBoundingClientRect();

    const ghost = document.createElement('div');
    ghost.style.cssText = `
      position: fixed;
      z-index: 10000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: url(${imageSrc}) center/cover no-repeat;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      pointer-events: none;
      left: ${sourceRect.left + sourceRect.width / 2 - 25}px;
      top: ${sourceRect.top + sourceRect.height / 2 - 25}px;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    document.body.appendChild(ghost);

    // Trigger animation
    requestAnimationFrame(() => {
      ghost.style.transform = `translate(${targetRect.left - sourceRect.left}px, ${targetRect.top - sourceRect.top}px) scale(0.5)`;
      ghost.style.opacity = '0';
    });

    return new Promise(resolve => {
      setTimeout(() => {
        ghost.remove();
        resolve();
      }, 500);
    });
  }

  // ============================================
  // PRODUCT DATA CACHE
  // ============================================
  const productDataCache = new Map();
  const handleToProductMap = new Map();

  productCards.forEach(card => {
    const data = {
      id: card.dataset.productId,
      handle: card.dataset.productHandle,
      title: card.dataset.productTitle,
      price: parseInt(card.dataset.productPrice),
      image: card.dataset.productImage,
      variantId: card.dataset.variantId,
      url: card.dataset.productUrl
    };
    productDataCache.set(data.id, { ...data, card });
    const handle = matchHandle(data.title);
    handleToProductMap.set(handle, { ...data, card });
  });

  function getProductDataByHandle(handle) {
    const cached = handleToProductMap.get(handle);
    return cached ? { ...cached, quantity: 1 } : null;
  }

  // ============================================
  // SYNERGY MAP RENDERER (v2)
  // ============================================
  const SynergyMapRenderer = {
    // Product positions in pentagon layout (x, y coordinates in SVG viewBox 400x280)
    POSITIONS: {
      'dailyglow': { x: 200, y: 55 },     // Top center
      'mindfuel': { x: 340, y: 120 },     // Right top
      'dreamglow': { x: 300, y: 230 },    // Right bottom
      'thechill': { x: 100, y: 230 },     // Left bottom
      'reset-button': { x: 60, y: 120 }   // Left top
    },
    NODE_RADIUS: 35,

    render(container, selectedHandles) {
      const svg = container.querySelector('.wa-synergy-map__svg');
      const labelsContainer = container.querySelector('.wa-synergy-map__labels');
      if (!svg || !labelsContainer) return;

      // Clear previous
      svg.innerHTML = '';
      labelsContainer.innerHTML = '';

      if (selectedHandles.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';

      // Render connections first (so they appear behind nodes)
      const connections = this.getActiveConnections(selectedHandles);
      connections.forEach(conn => this.renderConnection(svg, labelsContainer, conn));

      // Render all product nodes
      Object.entries(this.POSITIONS).forEach(([handle, pos]) => {
        const isSelected = selectedHandles.includes(handle);
        this.renderNode(svg, handle, pos, isSelected);
      });

      // Add click handlers to nodes
      this.bindNodeClickHandlers(svg);
    },

    bindNodeClickHandlers(svg) {
      svg.querySelectorAll('.wa-synergy-node').forEach(node => {
        node.addEventListener('click', (e) => {
          e.stopPropagation();
          const handle = node.getAttribute('data-handle');
          if (!handle) return;

          const isSelected = node.classList.contains('wa-synergy-node--selected');
          const product = handleToProductMap.get(handle);

          if (isSelected) {
            // Remove from cart
            const item = state.items.find(i => matchHandle(i.title) === handle);
            if (item) removeItem(item.id);
          } else if (product) {
            // Add to cart
            const card = document.querySelector(`.wa-product-card[data-product-handle="${handle}"]`);
            if (card) {
              const data = {
                id: card.dataset.productId,
                handle: card.dataset.productHandle,
                title: card.dataset.productTitle,
                price: parseInt(card.dataset.productPrice),
                image: card.dataset.productImage,
                variantId: card.dataset.variantId,
                url: card.dataset.productUrl,
                quantity: 1
              };
              addItem(data);
            }
          }
        });
      });
    },

    getActiveConnections(selectedHandles) {
      const connections = [];
      for (let i = 0; i < selectedHandles.length; i++) {
        for (let j = i + 1; j < selectedHandles.length; j++) {
          const h1 = selectedHandles[i], h2 = selectedHandles[j];
          const key = [h1, h2].sort().join('+');
          const conn = SYNERGY_CONNECTIONS[key];
          if (conn) {
            connections.push({
              ...conn,
              from: this.POSITIONS[h1],
              to: this.POSITIONS[h2],
              handles: [h1, h2]
            });
          }
        }
      }
      return connections;
    },

    renderNode(svg, handle, pos, isSelected) {
      const product = handleToProductMap.get(handle);
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('class', `wa-synergy-node ${isSelected ? 'wa-synergy-node--selected' : 'wa-synergy-node--inactive'}`);
      g.setAttribute('data-handle', handle);
      g.style.cursor = 'pointer';

      // Background circle
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', pos.x);
      circle.setAttribute('cy', pos.y);
      circle.setAttribute('r', this.NODE_RADIUS);
      circle.setAttribute('class', 'wa-synergy-node__bg');
      g.appendChild(circle);

      // Clip path for image
      const clipId = `clip-${handle}`;
      const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
      clipPath.setAttribute('id', clipId);
      const clipCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      clipCircle.setAttribute('cx', pos.x);
      clipCircle.setAttribute('cy', pos.y);
      clipCircle.setAttribute('r', this.NODE_RADIUS - 2);
      clipPath.appendChild(clipCircle);
      svg.appendChild(clipPath);

      // Product image
      if (product && product.image) {
        const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
        img.setAttribute('href', product.image);
        img.setAttribute('x', pos.x - this.NODE_RADIUS + 2);
        img.setAttribute('y', pos.y - this.NODE_RADIUS + 2);
        img.setAttribute('width', (this.NODE_RADIUS - 2) * 2);
        img.setAttribute('height', (this.NODE_RADIUS - 2) * 2);
        img.setAttribute('clip-path', `url(#${clipId})`);
        img.setAttribute('preserveAspectRatio', 'xMidYMid slice');
        g.appendChild(img);
      }

      // Glow effect for selected nodes
      if (isSelected) {
        const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        glow.setAttribute('cx', pos.x);
        glow.setAttribute('cy', pos.y);
        glow.setAttribute('r', this.NODE_RADIUS + 4);
        glow.setAttribute('class', 'wa-synergy-node__glow');
        g.insertBefore(glow, g.firstChild);
      }

      // Product name label below node
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pos.x);
      text.setAttribute('y', pos.y + this.NODE_RADIUS + 14);
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('class', 'wa-synergy-node__label');
      text.textContent = SYNERGY_MAP[handle]?.name || handle;
      g.appendChild(text);

      svg.appendChild(g);
    },

    renderConnection(svg, labelsContainer, conn) {
      const { from, to, color, label, strength, icon } = conn;

      // Create curved path between nodes
      const midX = (from.x + to.x) / 2;
      const midY = (from.y + to.y) / 2;
      const dx = to.x - from.x, dy = to.y - from.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      // Curve away from center (perpendicular offset)
      const perpX = -dy / dist * 20, perpY = dx / dist * 20;
      const ctrlX = midX + perpX, ctrlY = midY + perpY;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${from.x} ${from.y} Q ${ctrlX} ${ctrlY} ${to.x} ${to.y}`);
      path.setAttribute('class', `wa-synergy-line wa-synergy-line--${strength}`);
      path.setAttribute('stroke', color);
      path.setAttribute('fill', 'none');
      svg.insertBefore(path, svg.firstChild);

      // Add icon on connection line (positioned relative to SVG)
      const labelEl = document.createElement('div');
      labelEl.className = 'wa-synergy-label wa-synergy-label--icon';
      labelEl.style.left = `${(ctrlX / 400) * 100}%`;
      labelEl.style.top = `${(ctrlY / 280) * 100}%`;
      labelEl.style.background = color;
      labelEl.innerHTML = `<span>${icon || '‚ö°'}</span>`;
      labelsContainer.appendChild(labelEl);
    },

    renderSynergyList(container, selectedHandles) {
      const listContainer = container.querySelector('.wa-synergy-list');
      if (!listContainer) return;

      // Get all active connections/synergies
      const connections = this.getActiveConnections(selectedHandles);

      if (connections.length === 0) {
        listContainer.innerHTML = '';
        return;
      }

      // Build list HTML
      let html = '';
      connections.forEach(conn => {
        const key = conn.handles.sort().join('+');
        const expl = SYNERGY_EXPLANATIONS[key];
        if (expl) {
          html += `
            <div class="wa-synergy-list-item">
              <div class="wa-synergy-list-icon" style="background: ${conn.color}20; color: ${conn.color};">
                ${conn.icon || '‚ö°'}
              </div>
              <div class="wa-synergy-list-content">
                <div class="wa-synergy-list-title">${expl.title}</div>
                <div class="wa-synergy-list-benefit">${expl.benefit} - ${expl.detail}</div>
              </div>
            </div>
          `;
        }
      });

      listContainer.innerHTML = html;
    },

    update(selectedHandles) {
      // Update both mobile and desktop synergy maps (in merged containers)
      const dockMap = dock?.querySelector('.wa-dock__synergy-achievements');
      const sidebarMap = sidebar?.querySelector('.wa-synergy-achievements');
      if (dockMap) {
        this.render(dockMap, selectedHandles);
        this.renderSynergyList(dockMap, selectedHandles);
      }
      if (sidebarMap) {
        this.render(sidebarMap, selectedHandles);
        this.renderSynergyList(sidebarMap, selectedHandles);
      }
    }
  };

  // ============================================
  // PRICING & SYNERGY LOGIC
  // ============================================
  function calculatePricing() {
    const totalQty = getTotalQuantity();
    const bundleTier = Math.min(totalQty, 5);
    const bundleRate = bundleTier > 0 ? (SYNERGY_CONFIG[bundleTier]?.discount || 0) : 0;
    let subtotal = 0, totalDiscount = 0;

    state.items.forEach(item => {
      const qty = item.quantity || 1;
      const itemSub = item.price * qty;
      subtotal += itemSub;
      let rate = qty >= 6 ? 0.35 : qty >= 3 ? 0.30 : bundleRate;
      totalDiscount += Math.round(itemSub * rate);
    });

    return { subtotal, discount: totalDiscount, total: subtotal - totalDiscount };
  }

  function getSynergyExplanation() {
    if (state.items.length === 0) return null;
    if (state.items.length === 1) {
      const h = matchHandle(state.items[0].title);
      return SINGLE_PRODUCT_BENEFITS[h] || null;
    }
    const key = state.items.map(i => matchHandle(i.title)).sort().join('+');
    return SYNERGY_EXPLANATIONS[key] || { title: `${state.items.length}'li Paket`, benefit: `%${Math.round(SYNERGY_CONFIG[Math.min(state.items.length, 5)]?.discount * 100 || 0)} indirim`, detail: 'Urunler birlikte daha etkili.' };
  }

  function getRecommendation() {
    if (state.items.length === 0 || state.items.length >= 5) return null;
    const addedHandles = state.items.map(i => matchHandle(i.title));
    const recs = RECOMMENDATIONS[addedHandles[0]] || [];
    for (const r of recs) if (!addedHandles.includes(r.handle)) return r;
    for (const h of Object.keys(SYNERGY_MAP)) if (!addedHandles.includes(h)) return { handle: h, bundle: 'Rit√ºeli Tamamla', reason: 'ƒ∞ndirim seviyenizi artƒ±rƒ±n.' };
    return null;
  }

  function getRitualGuide() {
    if (state.items.length === 0) return null;
    const guide = [];
    const items = state.items.map(i => ({ ...i, handle: matchHandle(i.title), syn: SYNERGY_MAP[matchHandle(i.title)] }));
    items.filter(i => i.syn?.category === 'morning').forEach(p => guide.push({ time: 'Sabah', product: p.syn?.name || p.title, text: p.syn?.tip || '' }));
    items.filter(i => i.syn?.category === 'noon').forEach(p => guide.push({ time: 'Ogle', product: p.syn?.name || p.title, text: p.syn?.tip || '' }));
    items.filter(i => i.syn?.category === 'night').forEach(p => guide.push({ time: 'Aksam', product: p.syn?.name || p.title, text: p.syn?.tip || '' }));
    return guide.length > 0 ? guide : null;
  }

  // ============================================
  // SHOPIFY CART API
  // ============================================
  async function addToShopifyCart(variantId, qty = 1) {
    try {
      const res = await fetch('/cart/add.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: [{ id: parseInt(variantId), quantity: qty }] }) });
      return res.ok;
    } catch { return false; }
  }

  async function removeFromShopifyCart(variantId) {
    try {
      const res = await fetch('/cart/change.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: variantId.toString(), quantity: 0 }) });
      return res.ok;
    } catch { return false; }
  }

  async function updateShopifyCartQty(variantId, qty) {
    try {
      const res = await fetch('/cart/change.js', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: variantId.toString(), quantity: qty }) });
      return res.ok;
    } catch { return false; }
  }

  // ============================================
  // STATE MANAGEMENT
  // ============================================
  async function addItem(productData) {
    const existing = state.items.find(i => i.id === productData.id);
    if (existing) { await removeItem(productData.id); return false; }
    if (state.items.length >= 5) { vibrate([30, 20, 30]); return false; }

    const card = [...productCards].find(c => c.dataset.productId === productData.id);
    if (card) card.classList.add('wa-product-card--loading');
    const success = await addToShopifyCart(productData.variantId);
    if (card) card.classList.remove('wa-product-card--loading');

    if (success) {
      state.items.push({ ...productData, quantity: 1 });
      vibrate(10);
      updateUI();
      checkAchievements();
      if (state.isMobile && !state.isExpanded) setTimeout(() => { state.isExpanded = true; dock.classList.add('wa-dock--expanded'); }, 400);
      return true;
    }
    return false;
  }

  async function removeItem(productId) {
    const item = state.items.find(i => i.id === productId);
    if (item) await removeFromShopifyCart(item.variantId);
    state.items = state.items.filter(i => i.id !== productId);
    vibrate(10);
    updateUI();
  }

  async function updateQuantity(productId, delta) {
    const item = state.items.find(i => i.id === productId);
    if (!item) return;

    const newQty = item.quantity + delta;
    if (newQty <= 0) {
      // Remove item when quantity reaches 0
      removeItem(productId);
    } else {
      const clampedQty = Math.min(10, newQty);
      if (await updateShopifyCartQty(item.variantId, clampedQty)) {
        item.quantity = clampedQty;
        vibrate(5);
        updateUI();
      }
    }
  }

  // ============================================
  // ACHIEVEMENTS
  // ============================================
  function checkAchievements() {
    Object.values(ACHIEVEMENTS).forEach(ach => {
      if (!achievementState.unlocked.has(ach.id) && ach.condition(state)) {
        achievementState.unlocked.add(ach.id);
        achievementState.pending.push(ach);
      }
    });
    if (achievementState.pending.length > 0) processAchievementQueue();
    updateAchievementDisplay();
  }

  function processAchievementQueue() {
    if (achievementState.pending.length === 0) return;
    const ach = achievementState.pending.shift();
    showAchievementUnlock(ach);
  }

  function showAchievementUnlock(ach) {
    // Update achievement icons in merged container
    updateAchievementDisplay();
    showAchievementUnlockInBox(ach);

    // Also show floating notification
    const notif = document.createElement('div');
    notif.className = 'wa-achievement-notification';
    notif.innerHTML = `<div class="wa-achievement-notification__icon wa-achievement-notification__icon--locked">${ICONS.lock}</div><div><span class="wa-achievement-notification__label">Kilidi Acildi!</span><span class="wa-achievement-notification__title">${ach.title}</span></div>`;
    document.body.appendChild(notif);

    requestAnimationFrame(() => {
      notif.classList.add('wa-achievement-notification--visible');
      setTimeout(() => {
        const icon = notif.querySelector('.wa-achievement-notification__icon');
        icon.classList.remove('wa-achievement-notification__icon--locked');
        icon.classList.add('wa-achievement-notification__icon--unlocking');
        icon.innerHTML = ICONS.unlock;
        createMiniConfetti(notif);
      }, 300);
    });

    setTimeout(() => {
      notif.classList.add('wa-achievement-notification--hiding');
      setTimeout(() => { notif.remove(); setTimeout(processAchievementQueue, 200); }, 300);
    }, 2500);
  }

  function createMiniConfetti(el) {
    const rect = el.getBoundingClientRect();
    const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96E6A1'];
    for (let i = 0; i < 12; i++) {
      const c = document.createElement('div');
      c.className = 'wa-confetti';
      c.style.left = cx + 'px'; c.style.top = cy + 'px';
      c.style.background = colors[Math.floor(Math.random() * colors.length)];
      const angle = (Math.PI * 2 * i) / 12, vel = 30 + Math.random() * 40;
      c.style.setProperty('--tx', Math.cos(angle) * vel + 'px');
      c.style.setProperty('--ty', Math.sin(angle) * vel + 'px');
      c.style.setProperty('--rot', Math.random() * 720 - 360 + 'deg');
      particles.appendChild(c);
      setTimeout(() => c.remove(), 1000);
    }
  }

  function updateAchievementDisplay() {
    const unlocked = achievementState.unlocked.size;

    [sidebar, dock].forEach(container => {
      if (!container) return;
      // Update achievement icons in merged synergy-achievements container
      const merged = container.querySelector('.wa-synergy-achievements, .wa-dock__synergy-achievements');
      if (!merged) return;

      // Show merged container when there are items
      merged.style.display = state.items.length > 0 ? 'block' : 'none';

      // Update achievement icons
      const icons = merged.querySelectorAll('.wa-achievement-icon');
      icons.forEach(icon => {
        const achId = icon.dataset.achievement;
        const isUnlocked = achievementState.unlocked.has(achId);
        icon.classList.toggle('wa-achievement-icon--unlocked', isUnlocked);
      });
    });
  }

  function showAchievementUnlockInBox(achievement) {
    [sidebar, dock].forEach(container => {
      if (!container) return;
      const merged = container.querySelector('.wa-synergy-achievements, .wa-dock__synergy-achievements');
      if (!merged) return;

      // Find the icon and animate it
      const icon = merged.querySelector(`.wa-achievement-icon[data-achievement="${achievement.id}"]`);
      if (icon) {
        icon.classList.add('wa-achievement-icon--unlocking');
        setTimeout(() => icon.classList.remove('wa-achievement-icon--unlocking'), 600);
      }

      // Show unlock box
      const unlockBox = merged.querySelector('.wa-achievement-unlock-box');
      if (unlockBox) {
        unlockBox.style.display = 'block';
        unlockBox.innerHTML = `
          <div class="wa-achievement-unlock-box__header">
            <span class="wa-achievement-unlock-box__emoji">${achievement.emoji || '‚≠ê'}</span>
            <span>${achievement.title} Acildi!</span>
          </div>
          <p class="wa-achievement-unlock-box__text">${achievement.description}</p>
        `;
        // Auto-hide after 4 seconds
        setTimeout(() => {
          unlockBox.style.display = 'none';
        }, 4000);
      }
    });
  }

  // ============================================
  // UNIFIED RENDER FUNCTIONS (DRY)
  // ============================================
  function renderItemHTML(item, variant) {
    const handle = matchHandle(item.title);
    const benefit = SYNERGY_MAP[handle]?.benefit || '';
    const prefix = variant === 'dock' ? 'wa-dock' : 'wa-sidebar';
    return `<div class="${prefix}__item" data-product-id="${item.id}">
      <a href="${item.url || '/products/' + item.handle}" class="${prefix}__item-link">
        <img src="${item.image}" alt="${item.title}" class="${prefix}__item-image">
        <div class="${prefix}__item-info">
          <h4 class="${prefix}__item-title">${SYNERGY_MAP[handle]?.name || item.title}</h4>
          ${benefit ? `<p class="${prefix}__item-benefit">${benefit}</p>` : ''}
        </div>
      </a>
      <div class="${prefix}__item-controls">
        <div class="${prefix}__item-qty">
          <button class="${prefix}__item-qty-btn" data-qty-minus="${item.id}">-</button>
          <span class="${prefix}__item-qty-value">${item.quantity}</span>
          <button class="${prefix}__item-qty-btn" data-qty-plus="${item.id}">+</button>
        </div>
        <button class="${prefix}__item-remove" data-remove="${item.id}">${ICONS.close}</button>
      </div>
    </div>`;
  }

  function updateStepIndicators(container, level) {
    if (!container) return;
    container.querySelectorAll('.wa-step').forEach((s, i) => s.classList.toggle('active', i + 1 <= level));
  }

  // ============================================
  // UI UPDATE
  // ============================================
  function updateUI() {
    const pricing = calculatePricing();
    const totalQty = getTotalQuantity();
    const tier = Math.min(totalQty, 5);
    const synergy = totalQty > 0 ? SYNERGY_CONFIG[tier] : { percent: 0, text: 'Ba≈ülayƒ±n' };
    const rec = getRecommendation();
    const ritual = getRitualGuide();
    const synExp = getSynergyExplanation();

    // Update product cards
    productCards.forEach(card => {
      const isAdded = state.items.find(i => i.id === card.dataset.productId);
      card.classList.toggle('wa-product-card--added', !!isAdded);
      const cardHandle = matchHandle(card.dataset.productTitle);
      card.classList.toggle('wa-product-card--recommended', rec && cardHandle === rec.handle && !isAdded);
    });

    // Update synergy map with selected product handles
    const selectedHandles = state.items.map(i => matchHandle(i.title));
    SynergyMapRenderer.update(selectedHandles);

    if (state.isMobile) {
      updateMobileUI(pricing, synergy, tier, rec, ritual, synExp);
    } else {
      updateDesktopUI(pricing, synergy, tier, rec, ritual, synExp);
    }
  }

  function updateMobileUI(pricing, synergy, tier, rec, ritual, synExp) {
    dock.classList.toggle('wa-dock--empty', state.items.length === 0);
    if (state.items.length === 0 && state.isExpanded) { state.isExpanded = false; dock.classList.remove('wa-dock--expanded'); }

    // Thumbnails
    const thumbs = dock.querySelector('.wa-dock__thumbnails');
    const emptyTxt = dock.querySelector('.wa-dock__empty-text');
    thumbs.innerHTML = state.items.map(i => `<img src="${i.image}" class="wa-dock__thumbnail">`).join('');
    emptyTxt.style.display = state.items.length ? 'none' : 'block';

    // Info
    const totalQty = getTotalQuantity();
    dock.querySelector('.wa-dock__item-count').textContent = `${state.items.length} urun${totalQty > state.items.length ? ` (${totalQty} adet)` : ''}`;
    const badge = dock.querySelector('.wa-dock__synergy-badge');
    badge.textContent = synergy.text;
    badge.classList.toggle('wa-dock__synergy-badge--active', tier >= 2);
    dock.querySelector('.wa-dock__mini-total').textContent = formatMoney(pricing.total);

    // Synergy summary
    const summary = dock.querySelector('.wa-dock__synergy-summary');
    summary.style.display = state.items.length > 0 ? 'block' : 'none';
    updateStepIndicators(summary.querySelector('.wa-steps'), tier);
    const sumTxt = dock.querySelector('.wa-dock__synergy-summary-text');
    if (sumTxt) sumTxt.textContent = synExp ? `‚ö° ${synExp.benefit}` : '';

    // Items list
    dock.querySelector('.wa-dock__items').innerHTML = state.items.map(i => renderItemHTML(i, 'dock')).join('');

    // Synergy explanation
    const synBox = dock.querySelector('.wa-dock__synergy-explanation');
    if (synExp) {
      synBox.style.display = 'block';
      synBox.innerHTML = `<div style="display:flex;align-items:center;gap:6px;font-weight:600;margin-bottom:6px;">${ICONS.lightning}<span>${synExp.title}</span></div><div style="display:inline-block;background:#000;color:#fff;font-size:0.65rem;padding:2px 6px;border-radius:4px;margin-bottom:6px;">${synExp.benefit}</div><p style="margin:0;color:#525252;line-height:1.4;">${synExp.detail}</p>`;
    } else { synBox.style.display = 'none'; }

    // Recommendation (using cached elements for performance)
    if (rec && dockRecElements.container) {
      const rp = getProductDataByHandle(rec.handle);
      if (rp) {
        dockRecElements.container.style.display = 'block';
        dockRecElements.img.src = rp.image;
        dockRecElements.name.textContent = SYNERGY_MAP[rec.handle]?.name || rp.title;
        dockRecElements.bundle.textContent = SYNERGY_MAP[rec.handle]?.shortDesc || rec.bundle;
        dockRecElements.addBtn.dataset.recHandle = rec.handle;
      }
    } else if (dockRecElements.container) {
      dockRecElements.container.style.display = 'none';
    }

    // Ritual
    const ritBox = dock.querySelector('.wa-dock__ritual');
    if (ritual) {
      ritBox.style.display = 'block';
      ritBox.innerHTML = `<div style="font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px;">${ICONS.clock} Kullanƒ±m Rehberi</div>${ritual.map(r => `<div style="display:flex;gap:8px;margin-bottom:4px;"><span style="font-weight:600;min-width:50px;">${r.time}</span><span style="color:#525252;"><strong>${r.product}:</strong> ${r.text}</span></div>`).join('')}`;
    } else { ritBox.style.display = 'none'; }

    // Pricing
    dock.querySelector('.wa-dock__subtotal').textContent = formatMoney(pricing.subtotal);
    dock.querySelector('.wa-dock__discount').textContent = '-' + formatMoney(pricing.discount);
    dock.querySelector('.wa-dock__net-total').textContent = formatMoney(pricing.total);
    dock.querySelector('.wa-dock__total').textContent = formatMoney(pricing.total);
    dock.querySelector('.wa-dock__price-row--discount').style.display = pricing.discount > 0 ? 'flex' : 'none';
    dock.querySelector('.wa-dock__checkout-btn').disabled = state.items.length === 0;

    // Discount steps (top section with step indicators)
    const discountSteps = dock.querySelector('.wa-dock__discount-steps');
    if (discountSteps && state.items.length > 0) {
      const totalQtySteps = getTotalQuantity();
      const currentDiscount = SYNERGY_CONFIG[Math.min(totalQtySteps, 5)]?.discount || 0;
      const currentPercent = Math.round(currentDiscount * 100);

      // Update step indicators
      updateStepIndicators(discountSteps.querySelector('.wa-steps--top'), tier);

      // Update current discount text
      discountSteps.querySelector('.wa-dock__discount-steps-current').textContent = currentPercent > 0 ? `%${currentPercent} indirim` : 'Ba≈ülayƒ±n';

      // Hint text based on tier
      const hintText = discountSteps.querySelector('.wa-dock__discount-hint-text');
      if (hintText) {
        if (totalQtySteps >= 5) {
          hintText.innerHTML = 'üéâ <strong>Maksimum indirime ulastiniz!</strong>';
        } else {
          const nextTier = totalQtySteps + 1;
          const nextDiscount = Math.round((SYNERGY_CONFIG[nextTier]?.discount || 0) * 100);
          hintText.innerHTML = `<strong>1 urun</strong> daha ekle, <strong>%${nextDiscount}</strong> indirime ulas!`;
        }
      }
      discountSteps.style.display = 'block';
    } else if (discountSteps) {
      discountSteps.style.display = 'none';
    }
  }

  function updateDesktopUI(pricing, synergy, tier, rec, ritual, synExp) {
    sidebar.classList.toggle('wa-sidebar--has-items', state.items.length > 0);
    const totalQty = getTotalQuantity();
    sidebar.querySelector('.wa-sidebar__count').textContent = `${state.items.length} urun${totalQty > state.items.length ? ` (${totalQty} adet)` : ''}`;
    sidebar.querySelector('.wa-sidebar__items').innerHTML = state.items.map(i => renderItemHTML(i, 'sidebar')).join('');

    // Synergy explanation
    const synBox = sidebar.querySelector('.wa-synergy-explanation');
    if (synExp) {
      synBox.style.display = 'block';
      synBox.innerHTML = `<div class="wa-synergy-explanation__header">${ICONS.lightning}<span>${synExp.title}</span></div><div class="wa-synergy-explanation__benefit">${synExp.benefit}</div><p class="wa-synergy-explanation__text">${synExp.detail}</p>`;
    } else { synBox.style.display = 'none'; }

    // Recommendation (using cached elements for performance)
    if (rec && sidebarRecElements.container) {
      const rp = getProductDataByHandle(rec.handle);
      if (rp) {
        sidebarRecElements.container.style.display = 'block';
        sidebarRecElements.img.src = rp.image;
        sidebarRecElements.name.textContent = SYNERGY_MAP[rec.handle]?.name || rp.title;
        sidebarRecElements.bundleName.textContent = SYNERGY_MAP[rec.handle]?.shortDesc || rec.bundle;
        sidebarRecElements.reason.textContent = rec.reason;
        sidebarRecElements.addBtn.dataset.recHandle = rec.handle;
      }
    } else if (sidebarRecElements.container) {
      sidebarRecElements.container.style.display = 'none';
    }

    // Ritual
    const ritBox = sidebar.querySelector('.wa-ritual-guide');
    if (ritual) {
      ritBox.style.display = 'block';
      ritBox.querySelector('.wa-ritual-guide__content').innerHTML = ritual.map(r => `<div class="wa-ritual-guide__item"><span class="wa-ritual-guide__time">${r.time}</span><div><span class="wa-ritual-guide__product">${r.product}</span> <span class="wa-ritual-guide__text">${r.text}</span></div></div>`).join('');
    } else { ritBox.style.display = 'none'; }

    // Steps & Pricing
    updateStepIndicators(sidebar.querySelector('.wa-sidebar__synergy .wa-steps'), tier);
    sidebar.querySelector('.wa-sidebar__synergy-text').textContent = synergy.text;
    sidebar.querySelector('.wa-sidebar__subtotal').textContent = formatMoney(pricing.subtotal);
    sidebar.querySelector('.wa-sidebar__discount').textContent = '-' + formatMoney(pricing.discount);
    sidebar.querySelector('.wa-sidebar__total').textContent = formatMoney(pricing.total);
    sidebar.querySelector('.wa-sidebar__price-row--discount').style.display = pricing.discount > 0 ? 'flex' : 'none';
    sidebar.querySelector('.wa-sidebar__checkout-btn').disabled = state.items.length === 0;
  }

  // ============================================
  // KESFET MODAL (v2)
  // ============================================
  const kesfetModal = document.getElementById('kesfet-modal');
  let currentKe≈üfetHandle = null;
  let currentKe≈üfetProductData = null;

  function renderModalContent(handle, tab) {
    const data = EXTENDED_PRODUCT_DATA[handle];
    if (!data) return '<p>Bilgi bulunamadi.</p>';

    if (tab === 'benefits') {
      return data.benefits.map(b => `
        <div class="wa-modal-benefit-item">
          <div class="wa-modal-benefit-icon">${ICONS[b.icon] || ICONS.star}</div>
          <div>
            <div class="wa-modal-benefit-title">${b.title}</div>
            <p class="wa-modal-benefit-desc">${b.description}</p>
          </div>
        </div>
      `).join('');
    } else if (tab === 'ingredients') {
      return data.ingredients.map(i => `
        <div class="wa-modal-ingredient-item">
          <div>
            <div class="wa-modal-ingredient-name">${i.name}</div>
            <div class="wa-modal-ingredient-benefit">${i.benefit}</div>
          </div>
          ${i.amount ? `<div class="wa-modal-ingredient-amount">${i.amount}</div>` : ''}
        </div>
      `).join('');
    } else if (tab === 'science') {
      return `
        <div class="wa-modal-science">
          <div class="wa-modal-science-title">${data.science.title}</div>
          <p class="wa-modal-science-text">${data.science.description}</p>
        </div>
      `;
    } else if (tab === 'combinations') {
      // Find all synergy connections involving this product
      const combos = [];
      const allHandles = ['dailyglow', 'dreamglow', 'mindfuel', 'thechill', 'reset-button'];
      for (const other of allHandles) {
        if (other === handle) continue;
        const key = [handle, other].sort().join('+');
        const conn = SYNERGY_CONNECTIONS[key];
        const expl = SYNERGY_EXPLANATIONS[key];
        if (conn && expl) {
          const otherData = SYNERGY_MAP[other];
          combos.push({ handle: other, name: otherData?.name || other, label: conn.label, benefit: expl.benefit, detail: expl.detail, color: conn.color });
        }
      }

      if (combos.length === 0) {
        return '<p style="text-align:center;color:var(--wa-gray-500);">Bu √ºr√ºn i√ßin kombinasyon √∂nerisi bulunamadƒ±.</p>';
      }

      return combos.map(c => `
        <div class="wa-modal-combo-item" style="background:${c.color}10;border-left:3px solid ${c.color};">
          <div class="wa-modal-combo-header">
            <span class="wa-modal-combo-product">${c.name}</span>
            <span class="wa-modal-combo-label" style="background:${c.color};">${c.label}</span>
          </div>
          <div class="wa-modal-combo-benefit">${c.benefit}</div>
          <p class="wa-modal-combo-detail">${c.detail}</p>
        </div>
      `).join('');
    }
    return '';
  }

  function openKe≈üfetModal(card) {
    const handle = matchHandle(card.dataset.productTitle);
    const data = EXTENDED_PRODUCT_DATA[handle];
    if (!data) return;

    currentKe≈üfetHandle = handle;
    currentKe≈üfetProductData = {
      id: card.dataset.productId,
      handle: card.dataset.productHandle,
      title: card.dataset.productTitle,
      price: parseInt(card.dataset.productPrice),
      image: card.dataset.productImage,
      variantId: card.dataset.variantId,
      url: card.dataset.productUrl,
      quantity: 1
    };

    // Update modal content
    kesfetModal.querySelector('.wa-kesfet-modal__title').textContent = data.name;
    kesfetModal.querySelector('.wa-kesfet-modal__image').src = card.dataset.productImage;
    kesfetModal.querySelector('.wa-kesfet-modal__timing').innerHTML = `${ICONS.clock} ${data.timing}`;
    kesfetModal.querySelector('.wa-kesfet-modal__content').innerHTML = renderModalContent(handle, 'benefits');

    // Reset tabs
    kesfetModal.querySelectorAll('.wa-tab').forEach((t, i) => t.classList.toggle('wa-tab--active', i === 0));

    // Update add button / qty controls state
    const existingItem = state.items.find(i => i.id === currentKe≈üfetProductData.id);
    const addBtn = kesfetModal.querySelector('.wa-kesfet-modal__add-btn');
    const qtyControls = kesfetModal.querySelector('.wa-kesfet-modal__qty-controls');

    if (existingItem) {
      addBtn.style.display = 'none';
      qtyControls.style.display = 'flex';
      kesfetModal.querySelector('.wa-kesfet-modal__qty-value').textContent = existingItem.quantity;
    } else {
      addBtn.style.display = 'block';
      qtyControls.style.display = 'none';
    }

    // Open modal
    kesfetModal.classList.add('wa-kesfet-modal--open');
    document.body.style.overflow = 'hidden';
  }

  function closeKe≈üfetModal() {
    kesfetModal.classList.remove('wa-kesfet-modal--open');
    document.body.style.overflow = '';
    currentKe≈üfetHandle = null;
    currentKe≈üfetProductData = null;
  }

  function handleModalTab(tab) {
    if (!currentKe≈üfetHandle) return;
    kesfetModal.querySelector('.wa-kesfet-modal__content').innerHTML = renderModalContent(currentKe≈üfetHandle, tab);
    kesfetModal.querySelectorAll('.wa-tab').forEach(t => t.classList.toggle('wa-tab--active', t.dataset.tab === tab));
  }

  function handleModalAddToCart() {
    if (!currentKe≈üfetProductData) return;

    // Add item to cart
    addItem(currentKe≈üfetProductData);

    // Switch to qty controls
    const addBtn = kesfetModal.querySelector('.wa-kesfet-modal__add-btn');
    const qtyControls = kesfetModal.querySelector('.wa-kesfet-modal__qty-controls');
    addBtn.style.display = 'none';
    qtyControls.style.display = 'flex';
    kesfetModal.querySelector('.wa-kesfet-modal__qty-value').textContent = '1';
  }

  async function handleModalQtyChange(delta) {
    if (!currentKe≈üfetProductData) return;
    const item = state.items.find(i => i.id === currentKe≈üfetProductData.id);
    if (!item) return;

    const newQty = item.quantity + delta;
    const addBtn = kesfetModal.querySelector('.wa-kesfet-modal__add-btn');
    const qtyControls = kesfetModal.querySelector('.wa-kesfet-modal__qty-controls');

    if (newQty <= 0) {
      // Remove item and switch back to add button
      removeItem(currentKe≈üfetProductData.id);
      addBtn.style.display = 'block';
      qtyControls.style.display = 'none';
    } else {
      // Update quantity using existing updateQuantity logic
      const clampedQty = Math.min(10, newQty);
      if (await updateShopifyCartQty(item.variantId, clampedQty)) {
        item.quantity = clampedQty;
        vibrate(5);
        kesfetModal.querySelector('.wa-kesfet-modal__qty-value').textContent = clampedQty;
        updateUI();
      }
    }
  }

  // ============================================
  // EVENT HANDLERS
  // ============================================
  function handleProductClick(card, e) {
    // If clicking Ke≈üfet button, open modal
    if (e.target.closest('[data-kesfet-toggle]')) {
      e.stopPropagation();
      openKe≈üfetModal(card);
      return;
    }

    // Otherwise add to cart
    const data = { id: card.dataset.productId, handle: card.dataset.productHandle, title: card.dataset.productTitle, price: parseInt(card.dataset.productPrice), image: card.dataset.productImage, variantId: card.dataset.variantId, url: card.dataset.productUrl, quantity: 1 };
    addItem(data);
  }

  function toggleDock() { state.isExpanded = !state.isExpanded; dock.classList.toggle('wa-dock--expanded', state.isExpanded); }
  function handleCheckout() { if (state.items.length > 0) { vibrate([30, 60, 30]); window.location.href = '/checkout'; } }

  // ============================================
  // SYNC FROM CART
  // ============================================
  async function syncFromShopifyCart() {
    try {
      const res = await fetch('/cart.js');
      if (!res.ok) return;
      const cart = await res.json();
      for (const item of cart.items) {
        const variantId = item.variant_id.toString();
        const card = [...productCards].find(c => c.dataset.variantId === variantId);
        if (card && !state.items.find(i => i.variantId === variantId)) {
          state.items.push({ id: card.dataset.productId, handle: card.dataset.productHandle, title: card.dataset.productTitle, price: parseInt(card.dataset.productPrice), image: card.dataset.productImage, variantId, url: card.dataset.productUrl, quantity: item.quantity });
        }
      }
      updateUI();
    } catch {}
  }

  // ============================================
  // INITIALIZE
  // ============================================
  async function init() {
    window.addEventListener('resize', () => { const was = state.isMobile; state.isMobile = window.innerWidth < 768; if (was !== state.isMobile) updateUI(); });

    productCards.forEach(card => card.addEventListener('click', e => handleProductClick(card, e)));

    dock.querySelector('.wa-dock__handle').addEventListener('click', toggleDock);
    dock.querySelector('.wa-dock__expand-btn').addEventListener('click', toggleDock);
    dock.querySelector('.wa-dock__close-btn').addEventListener('click', toggleDock);
    dock.querySelector('.wa-dock__checkout-btn').addEventListener('click', handleCheckout);
    sidebar.querySelector('.wa-sidebar__checkout-btn').addEventListener('click', handleCheckout);

    // Event delegation for items
    [dock.querySelector('.wa-dock__items'), sidebar.querySelector('.wa-sidebar__items')].forEach(container => {
      if (!container) return;
      container.addEventListener('click', e => {
        const t = e.target.closest('[data-remove], [data-qty-minus], [data-qty-plus]');
        if (!t) return;
        if (t.dataset.remove) removeItem(t.dataset.remove);
        else if (t.dataset.qtyMinus) updateQuantity(t.dataset.qtyMinus, -1);
        else if (t.dataset.qtyPlus) updateQuantity(t.dataset.qtyPlus, 1);
      });
    });

    // Recommendation buttons with flying ghost animation
    dockRecElements.addBtn?.addEventListener('click', async e => {
      const h = e.target.dataset.recHandle;
      if (h) {
        const p = getProductDataByHandle(h);
        if (p) {
          // Flying ghost from recommendation image to dock items
          const targetEl = dock.querySelector('.wa-dock__items') || dock.querySelector('.wa-dock__thumbnails');
          await createFlyingGhost(dockRecElements.img, targetEl, p.image);
          addItem(p);
        }
      }
    });
    sidebarRecElements.addBtn?.addEventListener('click', async e => {
      const h = e.target.dataset.recHandle;
      if (h) {
        const p = getProductDataByHandle(h);
        if (p) {
          // Flying ghost from recommendation image to sidebar items
          const targetEl = sidebar.querySelector('.wa-sidebar__items');
          await createFlyingGhost(sidebarRecElements.img, targetEl, p.image);
          addItem(p);
        }
      }
    });

    // Ke≈üfet Modal event listeners
    if (kesfetModal) {
      kesfetModal.querySelector('.wa-kesfet-modal__close')?.addEventListener('click', closeKe≈üfetModal);
      kesfetModal.querySelector('.wa-kesfet-modal__back')?.addEventListener('click', closeKe≈üfetModal);
      kesfetModal.querySelector('.wa-kesfet-modal__add-btn')?.addEventListener('click', handleModalAddToCart);
      kesfetModal.querySelector('.wa-kesfet-modal__qty-minus')?.addEventListener('click', () => handleModalQtyChange(-1));
      kesfetModal.querySelector('.wa-kesfet-modal__qty-plus')?.addEventListener('click', () => handleModalQtyChange(1));
      kesfetModal.querySelectorAll('.wa-kesfet-modal__tabs .wa-tab').forEach(tab => {
        tab.addEventListener('click', () => handleModalTab(tab.dataset.tab));
      });
      // Close on backdrop click (clicking outside modal content)
      kesfetModal.addEventListener('click', e => {
        if (e.target === kesfetModal) closeKe≈üfetModal();
      });
    }

    // Swipe gestures for dock
    let touchStartY = 0;
    let touchCurrentY = 0;
    const expandedContent = dock.querySelector('.wa-dock__expanded');

    // Swipe-down to close (when expanded)
    if (expandedContent) {
      expandedContent.addEventListener('touchstart', e => {
        if (expandedContent.scrollTop === 0) {
          touchStartY = e.touches[0].clientY;
        }
      }, { passive: true });

      expandedContent.addEventListener('touchmove', e => {
        if (touchStartY > 0 && expandedContent.scrollTop === 0) {
          touchCurrentY = e.touches[0].clientY;
        }
      }, { passive: true });

      expandedContent.addEventListener('touchend', () => {
        if (touchStartY > 0 && touchCurrentY > 0) {
          const diff = touchCurrentY - touchStartY;
          if (diff > 100 && state.isExpanded) {
            toggleDock();
          }
        }
        touchStartY = 0;
        touchCurrentY = 0;
      });
    }

    // Swipe-up to open (when collapsed) - attach to entire dock for easier swiping
    let collapsedTouchStartY = 0;
    let collapsedTouchCurrentY = 0;

    dock.addEventListener('touchstart', e => {
      if (!state.isExpanded) {
        collapsedTouchStartY = e.touches[0].clientY;
      }
    }, { passive: true });

    dock.addEventListener('touchmove', e => {
      if (!state.isExpanded && collapsedTouchStartY > 0) {
        collapsedTouchCurrentY = e.touches[0].clientY;
      }
    }, { passive: true });

    dock.addEventListener('touchend', () => {
      if (!state.isExpanded && collapsedTouchStartY > 0 && collapsedTouchCurrentY > 0) {
        const diff = collapsedTouchStartY - collapsedTouchCurrentY; // Swipe UP = positive diff
        if (diff > 30 && state.items.length > 0) {
          toggleDock();
        }
      }
      collapsedTouchStartY = 0;
      collapsedTouchCurrentY = 0;
    });

    // Product page add-to-cart intercept
    // When user clicks "Add to Cart" on any product page, open the bundle builder slider instead
    setupProductPageIntercept();

    await syncFromShopifyCart();
    updateUI();
  }

  // Intercept add-to-cart clicks on product pages and redirect to bundle builder
  function setupProductPageIntercept() {
    // Common Shopify add-to-cart form selectors
    const addToCartSelectors = [
      'form[action*="/cart/add"] button[type="submit"]',
      'form[action*="/cart/add"] input[type="submit"]',
      '.product-form button[name="add"]',
      '.product-form__submit',
      '[data-add-to-cart]',
      '.add-to-cart',
      '#AddToCart',
      '.btn-add-to-cart'
    ];

    // Get all bundle product handles for matching
    const bundleHandles = new Set([...handleToProductMap.keys()]);

    // Listen for clicks on document (event delegation)
    document.addEventListener('click', async (e) => {
      // Check if clicked element matches any add-to-cart selector
      const btn = e.target.closest(addToCartSelectors.join(', '));
      if (!btn) return;

      // Find the product form
      const form = btn.closest('form[action*="/cart/add"]') || btn.closest('.product-form');
      if (!form) return;

      // Try to get the product handle from various sources
      let productHandle = null;

      // Method 1: From form input with name="id" (variant ID) - we need to match this
      const variantInput = form.querySelector('input[name="id"], select[name="id"]');
      if (variantInput) {
        const variantId = variantInput.value;
        // Check if this variant belongs to one of our bundle products
        for (const [handle, data] of handleToProductMap.entries()) {
          if (data.variantId == variantId) {
            productHandle = handle;
            break;
          }
        }
      }

      // Method 2: From URL pathname (e.g., /products/dreamglow)
      if (!productHandle) {
        const pathMatch = window.location.pathname.match(/\/products\/([^\/\?]+)/);
        if (pathMatch && bundleHandles.has(pathMatch[1])) {
          productHandle = pathMatch[1];
        }
      }

      // Method 3: From form data attribute
      if (!productHandle) {
        const formHandle = form.dataset.productHandle || form.dataset.handle;
        if (formHandle && bundleHandles.has(formHandle)) {
          productHandle = formHandle;
        }
      }

      // If we found a matching bundle product, intercept the add-to-cart
      if (productHandle) {
        e.preventDefault();
        e.stopPropagation();

        const productData = getProductDataByHandle(productHandle);
        if (productData) {
          // Add to bundle
          await addItem(productData);

          // Open the slider if on mobile, or scroll to builder on desktop
          if (state.isMobile) {
            if (!state.isExpanded) {
              state.isExpanded = true;
              dock.classList.add('wa-dock--expanded');
            }
          } else {
            // On desktop, scroll to the bundle builder section
            const bundleSection = document.querySelector('.wa-section--bundle-builder');
            if (bundleSection) {
              bundleSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }

          // Show visual feedback
          vibrate(10);
        }
      }
    }, true); // Use capture phase to intercept before other handlers

    // Also expose a global function for theme customization
    window.openBundleBuilder = function(handle) {
      if (handle) {
        const productData = getProductDataByHandle(handle);
        if (productData) addItem(productData);
      }
      if (state.isMobile) {
        state.isExpanded = true;
        dock.classList.add('wa-dock--expanded');
      }
    };
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>

{% schema %}
{
  "name": "Bundle Builder v2",
  "tag": "section",
  "class": "section-bundle-builder",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow_text",
      "label": "Ust Baslik",
      "default": "Kisisel Rit√ºeliniz"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Ana Baslik",
      "default": "Wellness Architect"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Alt Baslik",
      "default": "Size √∂zel √∂nerilerimizle rit√ºelinizi olu≈üturun."
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Urun Koleksiyonu"
    },
    {
      "type": "range",
      "id": "product_limit",
      "label": "Urun Limiti",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Bundle Builder v2",
      "category": "Products"
    }
  ]
}
{% endschema %}
